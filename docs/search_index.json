[["index.html", "AlberdiLab | Domestic-feral cat metagenomics Chapter 1 Introduction 1.1 Prepare the R environment", " AlberdiLab | Domestic-feral cat metagenomics Ostaizka Aizpurua1 Antton Alberdi2 2024-05-24 Chapter 1 Introduction This webbook contains all the code used for data analysis in study on the recovery of metagenome‑assembled genomes and derived microbial communities from tame and feral cat faecal samples collected in six countries. 1.1 Prepare the R environment 1.1.1 Environment To reproduce all the analyses locally, clone this repository in your computer using: RStudio &gt; New Project &gt; Version Control &gt; Git And indicating the following git repository: https://github.com/alberdilab/domestic_feral_cat_metagenomics.git Once the R project has been created, follow the instructions and code chunks shown in this webbook. 1.1.2 Libraries The following R packages are required for the data analysis. # Base library(R.utils) library(knitr) library(tidyverse) library(devtools) library(tinytable) library(broom) library(broom.mixed) # For tree handling library(ape) library(phyloseq) library(phytools) # For plotting library(ggplot2) library(ggrepel) library(ggpubr) library(ggnewscale) library(gridExtra) library(ggtreeExtra) library(ggtree) library(ggh4x) # For statistics library(spaa) library(vegan) library(Rtsne) library(geiger) library(hilldiv2) library(distillR) library(ANCOMBC) library(lme4) library(Hmsc) library(matrixStats) University of Copenhagen, ostaizka.aizpurua@sund.ku.dk↩︎ University of Copenhagen, antton.alberdi@sund.ku.dk↩︎ "],["data-preparation.html", "Chapter 2 Data preparation 2.1 Load data 2.2 Create working objects 2.3 Prepare color scheme 2.4 Prepare a phyloseq object 2.5 Wrap working objects", " Chapter 2 Data preparation 2.1 Load data Load the original data files outputted by the bioinformatic pipeline. 2.1.1 Sample metadata sample_metadata &lt;- read_csv(&quot;data/sample_metadata.csv&quot;) %&gt;% rename(sample=CombinedID) 2.1.2 Read counts read_counts &lt;- read_tsv(&quot;data/read_counts.tsv&quot;) %&gt;% rename(genome=1) %&gt;% select(c(&quot;genome&quot;,sample_metadata$sample)) 2.1.3 Genome coverage genome_coverage &lt;- read_tsv(&quot;data/genome_coverage.tsv&quot;) %&gt;% rename(genome=1) %&gt;% select(c(&quot;genome&quot;,sample_metadata$sample)) 2.1.4 Genome metadata genome_metadata &lt;- read_csv(&quot;data/genome_metadata.csv&quot;) %&gt;% mutate(phylum = case_when( phylum == &quot;Actinobacteriota&quot; ~ &quot;Actinomycetota&quot;, phylum == &quot;Firmicutes&quot; ~ &quot;Bacillota&quot;, phylum == &quot;Firmicutes_A&quot; ~ &quot;Bacillota_A&quot;, phylum == &quot;Firmicutes_C&quot; ~ &quot;Bacillota_C&quot;, phylum == &quot;Proteobacteria&quot; ~ &quot;Pseudomonadota&quot;, TRUE ~ phylum)) 2.1.5 Genome tree genome_tree &lt;- read_tree(&quot;data/genome_tree.tre&quot;) genome_tree$tip.label &lt;- str_replace_all(genome_tree$tip.label,&quot;&#39;&quot;, &quot;&quot;) #remove single quotes in MAG names genome_tree &lt;- keep.tip(genome_tree, tip=genome_metadata$genome) # keep only MAG tips 2.1.6 Genome annotations genome_annotations &lt;- read_tsv(&quot;data/genome_annotations.tsv.xz&quot;) %&gt;% rename(gene=1, genome=2, contig=3) 2.2 Create working objects Transform the original data files into working objects for downstream analyses. 2.2.1 Filter reads by coverage min_coverage=0.3 read_counts_filt &lt;- genome_coverage %&gt;% mutate(across(where(is.numeric), ~ ifelse(. &gt; min_coverage, 1, 0))) %&gt;% mutate(across(-1, ~ . * read_counts[[cur_column()]])) 2.2.2 Transform reads into genome counts readlength=150 genome_counts &lt;- read_counts %&gt;% mutate(across(where(is.numeric), ~ . / (genome_metadata$length / readlength) )) readlength=150 genome_counts_filt &lt;- read_counts_filt %&gt;% mutate(across(where(is.numeric), ~ . / (genome_metadata$length / readlength) )) 2.2.3 Distill annotations into GIFTs genome_gifts &lt;- distill(genome_annotations,GIFT_db,genomecol=2,annotcol=c(9,10,19), verbosity=F) 2.3 Prepare color scheme AlberdiLab projects use unified color schemes developed for the Earth Hologenome Initiative, to facilitate figure interpretation. phylum_colors &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) %&gt;% right_join(genome_metadata, by=join_by(phylum == phylum)) %&gt;% arrange(match(genome, genome_tree$tip.label)) %&gt;% select(phylum, colors) %&gt;% unique() %&gt;% arrange(phylum) %&gt;% pull(colors, name=phylum) 2.4 Prepare a phyloseq object phylo_samples &lt;- sample_metadata %&gt;% column_to_rownames(&quot;sample&quot;) %&gt;% sample_data() #convert to phyloseq sample_data object phylo_genome &lt;- genome_counts %&gt;% column_to_rownames(&quot;genome&quot;) %&gt;% otu_table(., taxa_are_rows = TRUE) phylo_taxonomy &lt;- genome_metadata %&gt;% select(c(1,5:10))%&gt;% column_to_rownames(&quot;genome&quot;) %&gt;% as.matrix() %&gt;% tax_table() #convert to phyloseq tax_table object physeq_genome &lt;- phyloseq(phylo_genome, phylo_taxonomy, phylo_samples) physeq_genome_clr &lt;- microbiome::transform(physeq_genome, &#39;clr&#39;) 2.5 Wrap working objects All working objects are wrapped into a single Rdata object to facilitate downstream usage. save(sample_metadata, genome_metadata, read_counts, genome_counts, genome_counts_filt, genome_tree, genome_gifts, phylum_colors, physeq_genome, physeq_genome_clr, file = &quot;data/data.Rdata&quot;) "],["mag-catalogue.html", "Chapter 3 MAG catalogue 3.1 Genome phylogeny 3.2 Genome quality 3.3 Functional overview 3.4 Functional ordination", " Chapter 3 MAG catalogue load(&quot;data/data.Rdata&quot;) 3.1 Genome phylogeny # Generate the phylum color heatmap phylum_heatmap &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) %&gt;% right_join(genome_metadata, by=join_by(phylum == phylum)) %&gt;% arrange(match(genome, genome_tree$tip.label)) %&gt;% select(genome,phylum) %&gt;% mutate(phylum = factor(phylum, levels = unique(phylum))) %&gt;% column_to_rownames(var = &quot;genome&quot;) # Generate basal tree circular_tree &lt;- force.ultrametric(genome_tree, method=&quot;extend&quot;) %&gt;% # extend to ultrametric for the sake of visualisation ggtree(., layout=&quot;fan&quot;, open.angle=10, size=0.5) *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** # Add phylum ring circular_tree &lt;- gheatmap(circular_tree, phylum_heatmap, offset=0.55, width=0.1, colnames=FALSE) + scale_fill_manual(values=phylum_colors) + geom_tiplab2(size=1, hjust=-0.1) + theme(legend.position = &quot;none&quot;, plot.margin = margin(0, 0, 0, 0), panel.margin = margin(0, 0, 0, 0)) # Flush color scale to enable a new color scheme in the next ring circular_tree &lt;- circular_tree + new_scale_fill() # Add completeness ring circular_tree &lt;- circular_tree + new_scale_fill() + scale_fill_gradient(low = &quot;#d1f4ba&quot;, high = &quot;#f4baba&quot;) + geom_fruit( data=genome_metadata, geom=geom_bar, mapping = aes(x=completeness, y=genome, fill=contamination), offset = 0.55, orientation=&quot;y&quot;, stat=&quot;identity&quot;) # Add genome-size ring circular_tree &lt;- circular_tree + new_scale_fill() + scale_fill_manual(values = &quot;#cccccc&quot;) + geom_fruit( data=genome_metadata, geom=geom_bar, mapping = aes(x=length, y=genome), offset = 0.05, orientation=&quot;y&quot;, stat=&quot;identity&quot;) # Add text circular_tree &lt;- circular_tree + annotate(&#39;text&#39;, x=2.7, y=0, label=&#39; Phylum&#39;, family=&#39;arial&#39;, size=3.5) + annotate(&#39;text&#39;, x=3.1, y=0, label=&#39; Genome quality&#39;, family=&#39;arial&#39;, size=3.5) + annotate(&#39;text&#39;, x=3.5, y=0, label=&#39; Genome size&#39;, family=&#39;arial&#39;, size=3.5) #Plot circular tree circular_tree %&gt;% open_tree(30) %&gt;% rotate_tree(90) 3.2 Genome quality tibble(Completeness= paste0(round(genome_metadata$completeness %&gt;% mean(),2), &quot;±&quot;, round(genome_metadata$completeness %&gt;% sd(),2)), Contamination= paste0(round(genome_metadata$contamination %&gt;% mean(),2), &quot;±&quot;, round(genome_metadata$contamination %&gt;% sd(),2))) %&gt;% tt() tinytable_abfln3bbvjw1dcc82ooc .table td.tinytable_css_xauz2zjcrccu5hlsdmi2, .table th.tinytable_css_xauz2zjcrccu5hlsdmi2 { border-bottom: solid 0.1em #d3d8dc; } Completeness Contamination 90.02±7.79 1.32±1.18 #Generate quality biplot genome_biplot &lt;- genome_metadata %&gt;% select(c(genome,phylum,completeness,contamination,length)) %&gt;% arrange(match(genome, rev(genome_tree$tip.label))) %&gt;% #sort MAGs according to phylogenetic tree ggplot(aes(x=completeness,y=contamination,size=length,color=phylum)) + geom_point(alpha=0.7) + xlim(c(70,100)) + ylim(c(10,0)) + scale_color_manual(values=phylum_colors) + labs(y= &quot;Contamination&quot;, x = &quot;Completeness&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;) #Generate contamination boxplot genome_contamination &lt;- genome_metadata %&gt;% ggplot(aes(y=contamination)) + ylim(c(10,0)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_void() + theme(legend.position = &quot;none&quot;, axis.title.x = element_blank(), axis.title.y = element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), plot.margin = unit(c(0, 0, 0.40, 0),&quot;inches&quot;)) #add bottom-margin (top, right, bottom, left) #Generate completeness boxplot genome_completeness &lt;- genome_metadata %&gt;% ggplot(aes(x=completeness)) + xlim(c(70,100)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_void() + theme(legend.position = &quot;none&quot;, axis.title.x = element_blank(), axis.title.y = element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), plot.margin = unit(c(0, 0, 0, 0.50),&quot;inches&quot;)) #add left-margin (top, right, bottom, left) #Render composite figure grid.arrange(grobs = list(genome_completeness,genome_biplot,genome_contamination), layout_matrix = rbind(c(1,1,1,1,1,1,1,1,1,1,1,4), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3))) 3.3 Functional overview # Aggregate basal GIFT into elements function_table &lt;- genome_gifts %&gt;% to.elements(., GIFT_db) # Generate basal tree function_tree &lt;- force.ultrametric(genome_tree, method=&quot;extend&quot;) %&gt;% ggtree(., size = 0.3) *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** #Add phylum colors next to the tree tips function_tree &lt;- gheatmap(function_tree, phylum_heatmap, offset=0, width=0.1, colnames=FALSE) + scale_fill_manual(values=phylum_colors) + labs(fill=&quot;Phylum&quot;) #Reset fill scale to use a different colour profile in the heatmap function_tree &lt;- function_tree + new_scale_fill() #Add functions heatmap function_tree &lt;- gheatmap(function_tree, function_table, offset=0.5, width=3.5, colnames=FALSE) + vexpand(.08) + coord_cartesian(clip = &quot;off&quot;) + scale_fill_gradient(low = &quot;#f4f4f4&quot;, high = &quot;steelblue&quot;, na.value=&quot;white&quot;) + labs(fill=&quot;GIFT&quot;) #Reset fill scale to use a different colour profile in the heatmap function_tree &lt;- function_tree + new_scale_fill() # Add completeness barplots function_tree &lt;- function_tree + geom_fruit(data=genome_metadata, geom=geom_bar, grid.params=list(axis=&quot;x&quot;, text.size=2, nbreak = 1), axis.params=list(vline=TRUE), mapping = aes(x=length, y=genome, fill=completeness), offset = 3.8, orientation=&quot;y&quot;, stat=&quot;identity&quot;) + scale_fill_gradient(low = &quot;#cf8888&quot;, high = &quot;#a2cc87&quot;) + labs(fill=&quot;Genome\\ncompleteness&quot;) function_tree 3.4 Functional ordination # Generate the tSNE ordination tSNE_function &lt;- Rtsne(X=function_table, dims = 2, check_duplicates = FALSE) # Plot the ordination function_ordination &lt;- tSNE_function$Y %&gt;% as.data.frame() %&gt;% mutate(genome=rownames(function_table)) %&gt;% inner_join(genome_metadata, by=&quot;genome&quot;) %&gt;% rename(tSNE1=&quot;V1&quot;, tSNE2=&quot;V2&quot;) %&gt;% select(genome,phylum,tSNE1,tSNE2, length) %&gt;% ggplot(aes(x = tSNE1, y = tSNE2, color = phylum, size=length))+ geom_point(shape=16, alpha=0.7) + scale_color_manual(values=phylum_colors) + theme_minimal() + labs(color=&quot;Phylum&quot;, size=&quot;Genome size&quot;) + guides(color = guide_legend(override.aes = list(size = 5))) # enlarge Phylum dots in legend function_ordination "],["community-composition.html", "Chapter 4 Community composition 4.1 Taxonomy overview 4.2 Taxonomy boxplot", " Chapter 4 Community composition load(&quot;data/data.Rdata&quot;) 4.1 Taxonomy overview 4.1.1 Stacked barplot genome_counts_filt %&gt;% mutate_at(vars(-genome),~./sum(.)) %&gt;% #apply TSS nornalisation pivot_longer(-genome, names_to = &quot;sample&quot;, values_to = &quot;count&quot;) %&gt;% #reduce to minimum number of columns left_join(., genome_metadata, by = join_by(genome == genome)) %&gt;% #append genome metadata left_join(., sample_metadata, by = join_by(sample == sample)) %&gt;% #append sample metadata filter(count &gt; 0) %&gt;% #filter 0 counts ggplot(., aes(x=sample,y=count, fill=phylum, group=phylum)) + #grouping enables keeping the same sorting of taxonomic units geom_bar(stat=&quot;identity&quot;, colour=&quot;white&quot;, linewidth=0.1) + #plot stacked bars with white borders scale_fill_manual(values=phylum_colors) + facet_nested(. ~ Location + Origin, scales=&quot;free&quot;) + #facet per day and treatment guides(fill = guide_legend(ncol = 1)) + theme(axis.text.x = element_blank(), axis.ticks.x =element_blank(), axis.title.x = element_blank(), axis.text.y = element_text(size=8), axis.title.y = element_text(size=12), panel.background = element_blank(), axis.line = element_line(linewidth = 0.5, linetype = &quot;solid&quot;, colour = &quot;black&quot;), panel.border = element_rect(colour = &quot;black&quot;, fill = NA), strip.background = element_rect(fill = &quot;white&quot;, color = &quot;black&quot;), strip.text = element_text(size = 12, lineheight = 0.6)) + labs(fill=&quot;Phylum&quot;,y = &quot;Relative abundance&quot;,x=&quot;Samples&quot;) 4.1.2 Phylum relative abundances phylum_summary &lt;- genome_counts_filt %&gt;% mutate_at(vars(-genome),~./sum(.)) %&gt;% #apply TSS nornalisation pivot_longer(-genome, names_to = &quot;sample&quot;, values_to = &quot;count&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == sample)) %&gt;% left_join(genome_metadata, by = join_by(genome == genome)) %&gt;% group_by(sample,phylum) %&gt;% summarise(relabun=sum(count)) phylum_summary %&gt;% group_by(phylum) %&gt;% summarise(mean=mean(relabun, na.rm=T),sd=sd(relabun, na.rm=T)) %&gt;% arrange(-mean) %&gt;% tt() tinytable_3p7zlugtg4jiyhnhgsfd .table td.tinytable_css_36dcnn1tnrvtel1fb6mz, .table th.tinytable_css_36dcnn1tnrvtel1fb6mz { border-bottom: solid 0.1em #d3d8dc; } phylum mean sd Bacteroidota 0.3174419111 0.183019959 Bacillota_A 0.1950249672 0.120311961 Actinomycetota 0.1816628641 0.164661070 Pseudomonadota 0.0906110310 0.129035667 Campylobacterota 0.0753140001 0.122740598 Bacillota_C 0.0657125307 0.090589426 Bacillota 0.0558322249 0.084087344 Fusobacteriota 0.0169238273 0.036464401 Desulfobacterota 0.0012635896 0.004283801 Cyanobacteria 0.0002130539 0.001747414 phylum_arrange &lt;- phylum_summary %&gt;% group_by(phylum) %&gt;% summarise(mean=mean(relabun)) %&gt;% arrange(-mean) %&gt;% select(phylum) %&gt;% pull() phylum_summary %&gt;% filter(phylum %in% phylum_arrange) %&gt;% mutate(phylum=factor(phylum,levels=rev(phylum_arrange))) %&gt;% ggplot(aes(x=relabun, y=phylum, group=phylum, color=phylum)) + scale_color_manual(values=phylum_colors[rev(phylum_arrange)]) + geom_jitter(alpha=0.5) + theme_minimal() + theme(legend.position=&quot;none&quot;) + labs(y=&quot;Phylum&quot;,x=&quot;Relative abundance&quot;) 4.1.3 Phylum percentages by behaviour Tame cats tinytable_evh19289bom8xwoihl8h .table td.tinytable_css_ur8tyoavwgtfrai42d2t, .table th.tinytable_css_ur8tyoavwgtfrai42d2t { border-bottom: solid 0.1em #d3d8dc; } Phylum mean sd Bacteroidota 32.56152690 17.0735823 Bacillota_A 19.43901972 9.2325815 Actinomycetota 18.15297600 14.6097544 Pseudomonadota 8.58500960 8.8366787 Campylobacterota 7.99160260 11.4635975 Bacillota_C 7.03812491 9.0283540 Bacillota 4.78213672 6.8948853 Fusobacteriota 1.24402612 1.8499876 Desulfobacterota 0.17332897 0.3125926 Cyanobacteria 0.03224846 0.2207708 Feral cats tinytable_qrf3u9rdj97p8i0qp2c7 .table td.tinytable_css_up0d6770odcnrdgpeh4a, .table th.tinytable_css_up0d6770odcnrdgpeh4a { border-bottom: solid 0.1em #d3d8dc; } Phylum mean sd Bacteroidota 28.216582864 17.60825972 Bacillota_A 24.008928630 11.57531069 Actinomycetota 17.469038917 14.43475736 Pseudomonadota 8.640301288 12.50709604 Bacillota_C 7.456856533 8.95839921 Bacillota 7.173243065 8.66411699 Campylobacterota 4.450683081 6.19179683 Fusobacteriota 2.234878008 4.15301854 Desulfobacterota 0.342681443 0.81138291 Cyanobacteria 0.006806171 0.03760557 4.2 Taxonomy boxplot 4.2.1 Family family_summary &lt;- genome_counts_filt %&gt;% mutate_at(vars(-genome),~./sum(.)) %&gt;% #apply TSS nornalisation pivot_longer(-genome, names_to = &quot;sample&quot;, values_to = &quot;count&quot;) %&gt;% #reduce to minimum number of columns left_join(sample_metadata, by = join_by(sample == sample)) %&gt;% #append sample metadata left_join(., genome_metadata, by = join_by(genome == genome)) %&gt;% #append genome metadata group_by(sample,family) %&gt;% summarise(relabun=sum(count)) family_summary %&gt;% group_by(family) %&gt;% summarise(mean=mean(relabun, na.rm=T),sd=sd(relabun, na.rm=T)) %&gt;% arrange(-mean) %&gt;% tt() tinytable_x36hd8mcpvyy8ffn1ia8 .table td.tinytable_css_sf7i4wgdaflwznzip6q8, .table th.tinytable_css_sf7i4wgdaflwznzip6q8 { border-bottom: solid 0.1em #d3d8dc; } family mean sd Bacteroidaceae 2.957679e-01 0.1794702282 Lachnospiraceae 1.072346e-01 0.0913528566 Coriobacteriaceae 9.631433e-02 0.1009342181 Helicobacteraceae 5.410633e-02 0.1022560566 Megasphaeraceae 3.895540e-02 0.0732948425 Enterobacteriaceae 3.671005e-02 0.1156492986 Bifidobacteriaceae 3.634821e-02 0.0642309973 Succinivibrionaceae 3.534985e-02 0.0599537024 Ruminococcaceae 3.408006e-02 0.0348433297 Actinomycetaceae 3.080463e-02 0.0930244958 Campylobacteraceae 2.120767e-02 0.0374825084 Lactobacillaceae 2.056464e-02 0.0600942736 Fusobacteriaceae 1.692383e-02 0.0364644007 Clostridiaceae 1.655096e-02 0.0573573568 Burkholderiaceae 1.538244e-02 0.0157737872 Atopobiaceae 1.510044e-02 0.0393574894 Erysipelotrichaceae 1.498819e-02 0.0297202782 Porphyromonadaceae 1.231678e-02 0.0490743570 Oscillospiraceae 1.169099e-02 0.0154660823 Dialisteraceae 1.109249e-02 0.0168027270 Peptoniphilaceae 1.027007e-02 0.0377623762 Streptococcaceae 1.009343e-02 0.0465284432 Selenomonadaceae 9.051718e-03 0.0152538557 Acidaminococcaceae 6.612925e-03 0.0134491243 Erysipelatoclostridiaceae 6.598637e-03 0.0107938056 Peptostreptococcaceae 6.477379e-03 0.0101260977 Anaerovoracaceae 4.239616e-03 0.0103079362 Tannerellaceae 3.414585e-03 0.0079108669 Pasteurellaceae 2.963621e-03 0.0184648739 Enterococcaceae 2.804985e-03 0.0085239000 Mycobacteriaceae 2.785187e-03 0.0190576068 Rikenellaceae 2.616836e-03 0.0106713550 Acutalibacteraceae 2.198544e-03 0.0044303862 Marinifilaceae 2.086026e-03 0.0055223355 Butyricicoccaceae 1.463315e-03 0.0031506247 Desulfovibrionaceae 1.263590e-03 0.0042838013 Muribaculaceae 9.291851e-04 0.0040885460 UBA660 6.460679e-04 0.0035734633 Anaerotignaceae 5.353989e-04 0.0025028446 Barnesiellaceae 3.105707e-04 0.0011701232 UMGS124 3.100703e-04 0.0017862741 Gastranaerophilaceae 2.130539e-04 0.0017474140 CAG-508 2.052995e-04 0.0007194205 CAG-239 2.050753e-04 0.0018010322 CAG-826 1.362811e-04 0.0007776869 UBA1381 7.878665e-05 0.0007556950 family_arrange &lt;- family_summary %&gt;% group_by(family) %&gt;% summarise(mean=sum(relabun)) %&gt;% arrange(-mean) %&gt;% select(family) %&gt;% pull() # Per origin family_summary %&gt;% left_join(genome_metadata %&gt;% select(family,phylum) %&gt;% unique(),by=join_by(family==family)) %&gt;% left_join(sample_metadata,by=join_by(sample==sample)) %&gt;% filter(family %in% family_arrange[1:20]) %&gt;% mutate(family=factor(family,levels=rev(family_arrange[1:20]))) %&gt;% filter(relabun &gt; 0) %&gt;% ggplot(aes(x=relabun, y=family, group=family, color=phylum)) + scale_color_manual(values=phylum_colors[-8]) + geom_jitter(alpha=0.5) + facet_grid(.~Origin)+ theme_minimal() + labs(y=&quot;Family&quot;, x=&quot;Relative abundance&quot;, color=&quot;Phylum&quot;) # Per location family_summary %&gt;% left_join(genome_metadata %&gt;% select(family,phylum) %&gt;% unique(),by=join_by(family==family)) %&gt;% left_join(sample_metadata,by=join_by(sample==sample)) %&gt;% filter(family %in% family_arrange[1:20]) %&gt;% mutate(family=factor(family,levels=rev(family_arrange[1:20]))) %&gt;% filter(relabun &gt; 0) %&gt;% ggplot(aes(x=relabun, y=family, group=family, color=phylum)) + scale_color_manual(values=phylum_colors[-8]) + geom_jitter(alpha=0.5) + facet_grid(.~Location)+ theme_minimal() + labs(y=&quot;Family&quot;, x=&quot;Relative abundance&quot;, color=&quot;Phylum&quot;) 4.2.2 Genus genus_summary &lt;- genome_counts_filt %&gt;% mutate_at(vars(-genome),~./sum(.)) %&gt;% #apply TSS nornalisation pivot_longer(-genome, names_to = &quot;sample&quot;, values_to = &quot;count&quot;) %&gt;% #reduce to minimum number of columns left_join(sample_metadata, by = join_by(sample == sample)) %&gt;% #append sample metadata left_join(genome_metadata, by = join_by(genome == genome)) %&gt;% #append genome metadata group_by(sample,phylum,genus) %&gt;% summarise(relabun=sum(count)) %&gt;% filter(genus != &quot;g__&quot;) %&gt;% mutate(genus= sub(&quot;^g__&quot;, &quot;&quot;, genus)) genus_summary_sort &lt;- genus_summary %&gt;% group_by(genus) %&gt;% summarise(mean=mean(relabun, na.rm=T),sd=sd(relabun, na.rm=T)) %&gt;% arrange(-mean) genus_summary_sort %&gt;% tt() tinytable_il78x7d51t6ldw4xggx6 .table td.tinytable_css_7k0d021w7b8euorf2c7q, .table th.tinytable_css_7k0d021w7b8euorf2c7q { border-bottom: solid 0.1em #d3d8dc; } genus mean sd Prevotella 1.364856e-01 0.1353999322 Collinsella 9.631433e-02 0.1009342181 Phocaeicola 8.993433e-02 0.0955977240 Bacteroides 5.173169e-02 0.0635714050 Megasphaera 3.869704e-02 0.0730748863 Helicobacter_B 3.657334e-02 0.0843378196 Bifidobacterium 3.634821e-02 0.0642309973 Anaerobiospirillum 3.459305e-02 0.0599454952 Escherichia 3.275523e-02 0.1083759749 Roseburia 2.314992e-02 0.0533913900 Campylobacter_D 2.120767e-02 0.0374825084 Blautia_A 2.051642e-02 0.0231346773 Pauljensenia 1.977626e-02 0.0800352518 Negativibacillus 1.819490e-02 0.0215815280 Prevotellamassilia 1.738141e-02 0.0343949273 Helicobacter_A 1.713427e-02 0.0507397988 Clostridium_P 1.645501e-02 0.0573123071 Fusobacterium_B 1.469492e-02 0.0345732902 Sutterella 1.425550e-02 0.0152994499 Blautia 1.333921e-02 0.0183592066 UBA7748 1.330938e-02 0.0382333948 Porphyromonas_A 1.231678e-02 0.0490743570 Trueperella 1.102837e-02 0.0501260208 Ligilactobacillus 1.038602e-02 0.0327671906 Dialister 1.031903e-02 0.0157533129 Streptococcus 9.357277e-03 0.0446998121 Gemmiger 8.872488e-03 0.0146460260 Holdemanella 8.793459e-03 0.0187067258 Lactobacillus 8.261034e-03 0.0348551627 Clostridium_Q 7.967312e-03 0.0129501748 Ruminococcus_B 7.491864e-03 0.0133624741 Megamonas 6.998825e-03 0.0128982165 Peptacetobacter 6.477379e-03 0.0101260977 Catenibacterium 6.451673e-03 0.0106973049 Faecalimonas 6.214440e-03 0.0112084591 Faecalibacterium 6.206186e-03 0.0133252461 Bulleidia 6.127964e-03 0.0165765313 Lawsonibacter 5.743270e-03 0.0087015993 Peptoniphilus_A 4.928663e-03 0.0217722683 Acidaminococcus 4.738436e-03 0.0131157898 Eisenbergiella 4.302829e-03 0.0073261825 Plesiomonas 3.954812e-03 0.0176151160 Parabacteroides 3.414585e-03 0.0079108669 Catenibacillus 3.242799e-03 0.0054534742 Histophilus 2.963621e-03 0.0184648739 Alistipes 2.616836e-03 0.0106713550 CAG-81 2.576496e-03 0.0041736848 Mediterraneibacter 2.497312e-03 0.0073570318 Sellimonas 2.293821e-03 0.0042562326 Dysosmobacter 2.255402e-03 0.0038273521 Fusobacterium_A 2.228906e-03 0.0084702675 Mitsuokella 2.052893e-03 0.0089367483 Ruminococcus_A 2.042994e-03 0.0028573373 Corynebacterium 1.947467e-03 0.0162046636 CAG-317 1.827371e-03 0.0032549462 Parolsenella 1.791055e-03 0.0042478478 Odoribacter 1.786646e-03 0.0054424090 Phascolarctobacterium_A 1.773898e-03 0.0045007766 UMGS905 1.691812e-03 0.0039135118 Limosilactobacillus 1.637804e-03 0.0065016504 Flavonifractor 1.526253e-03 0.0030043128 S5-A14a 1.461682e-03 0.0086194900 CAG-110 1.454019e-03 0.0077541828 VUNA01 1.401454e-03 0.0054991752 Butyricicoccus 1.357370e-03 0.0031145926 Enterococcus_B 1.310733e-03 0.0059365102 Schaedlerella 1.305216e-03 0.0026356164 Desulfovibrio 1.146069e-03 0.0040502698 Enterocloster 1.081652e-03 0.0016014566 CAG-521 1.044864e-03 0.0044915406 Robinsoniella 1.000496e-03 0.0022500094 CAG-279 9.291851e-04 0.0040885460 Enterococcus_E 8.894621e-04 0.0052314621 Fusicatenibacter 8.503089e-04 0.0040305315 Lawsonella 8.377194e-04 0.0044649755 Allisonella 7.734581e-04 0.0017636201 Lactococcus 7.361496e-04 0.0045553482 UMGS1370 7.113596e-04 0.0019148297 Lachnospira 6.870854e-04 0.0021298406 Dorea_B 6.868715e-04 0.0019244447 Bariatricus 6.260243e-04 0.0020974371 UBA9502 6.094947e-04 0.0010769033 Enterococcus 6.047896e-04 0.0038126660 UMGS1472 5.927633e-04 0.0010326554 Emergencia 5.805635e-04 0.0012817363 Succinivibrio 5.598203e-04 0.0022589496 Anaerotignum 5.353989e-04 0.0025028446 CAG-877 5.310297e-04 0.0030198616 Hungatella_A 5.159539e-04 0.0024856275 Evtepia 4.179293e-04 0.0010548717 Eubacterium_M 3.872451e-04 0.0020920297 Ruminococcus_C 3.818769e-04 0.0021783041 Anaerobutyricum 3.713931e-04 0.0007790163 Barnesiella 3.105707e-04 0.0011701232 Butyricimonas 2.993807e-04 0.0011821610 UMGS1872 2.941129e-04 0.0019462982 Mobilibacterium 2.870924e-04 0.0013257840 Fournierella 2.796504e-04 0.0011213974 Eubacterium_H 2.754780e-04 0.0018906167 Caecibacter 2.583579e-04 0.0011470773 Clostridium_A 2.543803e-04 0.0019730949 Helicobacter_C 2.498036e-04 0.0018283330 Paraprevotella 2.348920e-04 0.0018824059 Latilactobacillus 2.222007e-04 0.0021312745 Dorea_A 2.150652e-04 0.0015260870 Zag111 2.130539e-04 0.0017474140 CAG-354 2.052995e-04 0.0007194205 CAG-495 2.050753e-04 0.0018010322 Anaerobiospirillum_A 1.969800e-04 0.0010117016 Peptoniphilus_C 1.797556e-04 0.0017241550 Eubacterium_G 1.536509e-04 0.0010434640 Helicobacter_D 1.489164e-04 0.0009489548 Erysipelatoclostridium 1.469635e-04 0.0005908793 Phocea 1.449534e-04 0.0004735835 Ruminococcus_E 1.382618e-04 0.0012752336 UBA4855 1.362811e-04 0.0007776869 CAG-145 1.215784e-04 0.0004454832 Mailhella 1.175204e-04 0.0005162449 CAG-988 1.150383e-04 0.0008178711 Marseille-P4683 1.140905e-04 0.0005092329 AM07-15 1.059455e-04 0.0004745690 Phascolarctobacterium 1.005920e-04 0.0007816980 Clostridium 9.595775e-05 0.0005366982 Anaerostipes 8.894740e-05 0.0004351045 Parasutterella 8.207495e-05 0.0007872353 CAG-41 7.878665e-05 0.0007556950 Absicoccus 6.676847e-05 0.0002502435 Levilactobacillus 5.757608e-05 0.0005522504 genus_arrange &lt;- genus_summary %&gt;% group_by(genus) %&gt;% summarise(mean=sum(relabun)) %&gt;% filter(genus != &quot;g__&quot;)%&gt;% arrange(-mean) %&gt;% select(genus) %&gt;% mutate(genus= sub(&quot;^g__&quot;, &quot;&quot;, genus)) %&gt;% pull() #Per day genus_summary %&gt;% left_join(sample_metadata,by=join_by(sample==sample)) %&gt;% mutate(genus=factor(genus, levels=rev(genus_summary_sort %&gt;% pull(genus)))) %&gt;% filter(relabun &gt; 0) %&gt;% ggplot(aes(x=relabun, y=genus, group=genus, color=phylum)) + scale_color_manual(values=phylum_colors) + geom_jitter(alpha=0.5) + facet_grid(.~Origin)+ theme_minimal() + labs(y=&quot;Family&quot;, x=&quot;Relative abundance&quot;, color=&quot;Phylum&quot;) "],["alpha-diversity.html", "Chapter 5 Alpha diversity", " Chapter 5 Alpha diversity load(&quot;data/data.Rdata&quot;) # Calculate Hill numbers richness &lt;- genome_counts_filt %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% dplyr::select(where(~ !all(. == 0))) %&gt;% hilldiv(., q = 0) %&gt;% t() %&gt;% as.data.frame() %&gt;% dplyr::rename(richness = 1) %&gt;% rownames_to_column(var = &quot;sample&quot;) neutral &lt;- genome_counts_filt %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% dplyr::select(where(~ !all(. == 0))) %&gt;% hilldiv(., q = 1) %&gt;% t() %&gt;% as.data.frame() %&gt;% dplyr::rename(neutral = 1) %&gt;% rownames_to_column(var = &quot;sample&quot;) phylogenetic &lt;- genome_counts_filt %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% dplyr::select(where(~ !all(. == 0))) %&gt;% hilldiv(., q = 1, tree = genome_tree) %&gt;% t() %&gt;% as.data.frame() %&gt;% dplyr::rename(phylogenetic = 1) %&gt;% rownames_to_column(var = &quot;sample&quot;) # Aggregate basal GIFT into elements dist &lt;- genome_gifts %&gt;% to.elements(., GIFT_db) %&gt;% traits2dist(., method = &quot;gower&quot;) functional &lt;- genome_counts_filt %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% dplyr::select(where(~ !all(. == 0))) %&gt;% hilldiv(., q = 1, dist = dist) %&gt;% t() %&gt;% as.data.frame() %&gt;% dplyr::rename(functional = 1) %&gt;% rownames_to_column(var = &quot;sample&quot;) %&gt;% mutate(functional = if_else(is.nan(functional), 1, functional)) # Merge all metrics alpha_div &lt;- richness %&gt;% full_join(neutral, by = join_by(sample == sample)) %&gt;% full_join(phylogenetic, by = join_by(sample == sample)) %&gt;% full_join(functional, by = join_by(sample == sample)) #Richness alpha_div %&gt;% pivot_longer(-sample, names_to = &quot;metric&quot;, values_to = &quot;value&quot;) %&gt;% left_join(., sample_metadata, by = join_by(sample == sample)) %&gt;% filter(!is.na(Location)) %&gt;% filter(metric==&quot;richness&quot;) %&gt;% ggplot(aes(y = value, x = Origin, group=Origin, color=Origin, fill=Origin)) + geom_boxplot(outlier.shape = NA) + geom_jitter(alpha=0.5) + scale_color_manual(name=&quot;Origin&quot;, breaks=c(&quot;Tame&quot;,&quot;Feral&quot;), values=c(&quot;#6A9AC3&quot;,&quot;#F3B942&quot;)) + scale_fill_manual(name=&quot;Origin&quot;, breaks=c(&quot;Tame&quot;,&quot;Feral&quot;), values=c(&quot;#6A9AC350&quot;,&quot;#F3B94250&quot;)) + facet_wrap(. ~ Location, scales = &quot;fixed&quot;, ncol=6) + coord_cartesian(xlim = c(1, NA)) + theme_classic() + theme( strip.background = element_blank(), panel.grid.minor.x = element_line(size = .1, color = &quot;grey&quot;), axis.title.x = element_blank(), axis.title.y = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1) ) #Neutral alpha_div %&gt;% pivot_longer(-sample, names_to = &quot;metric&quot;, values_to = &quot;value&quot;) %&gt;% left_join(., sample_metadata, by = join_by(sample == sample)) %&gt;% filter(!is.na(Location)) %&gt;% filter(metric==&quot;neutral&quot;) %&gt;% ggplot(aes(y = value, x = Origin, group=Origin, color=Origin, fill=Origin)) + geom_boxplot(outlier.shape = NA) + geom_jitter(alpha=0.5) + scale_color_manual(name=&quot;Origin&quot;, breaks=c(&quot;Tame&quot;,&quot;Feral&quot;), values=c(&quot;#6A9AC3&quot;,&quot;#F3B942&quot;)) + scale_fill_manual(name=&quot;Origin&quot;, breaks=c(&quot;Tame&quot;,&quot;Feral&quot;), values=c(&quot;#6A9AC350&quot;,&quot;#F3B94250&quot;)) + facet_wrap(. ~ Location, scales = &quot;fixed&quot;, ncol=6) + coord_cartesian(xlim = c(1, NA)) + theme_classic() + theme( strip.background = element_blank(), panel.grid.minor.x = element_line(size = .1, color = &quot;grey&quot;), axis.title.x = element_blank(), axis.title.y = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1) ) #Phylogenetic alpha_div %&gt;% pivot_longer(-sample, names_to = &quot;metric&quot;, values_to = &quot;value&quot;) %&gt;% left_join(., sample_metadata, by = join_by(sample == sample)) %&gt;% filter(!is.na(Location)) %&gt;% filter(metric==&quot;phylogenetic&quot;) %&gt;% ggplot(aes(y = value, x = Origin, group=Origin, color=Origin, fill=Origin)) + geom_boxplot(outlier.shape = NA) + geom_jitter(alpha=0.5) + scale_color_manual(name=&quot;Origin&quot;, breaks=c(&quot;Tame&quot;,&quot;Feral&quot;), values=c(&quot;#6A9AC3&quot;,&quot;#F3B942&quot;)) + scale_fill_manual(name=&quot;Origin&quot;, breaks=c(&quot;Tame&quot;,&quot;Feral&quot;), values=c(&quot;#6A9AC350&quot;,&quot;#F3B94250&quot;)) + facet_wrap(. ~ Location, scales = &quot;fixed&quot;, ncol=6) + coord_cartesian(xlim = c(1, NA)) + theme_classic() + theme( strip.background = element_blank(), panel.grid.minor.x = element_line(size = .1, color = &quot;grey&quot;), axis.title.x = element_blank(), axis.title.y = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1) ) #Functional alpha_div %&gt;% pivot_longer(-sample, names_to = &quot;metric&quot;, values_to = &quot;value&quot;) %&gt;% left_join(., sample_metadata, by = join_by(sample == sample)) %&gt;% filter(!is.na(Location)) %&gt;% filter(metric==&quot;functional&quot;) %&gt;% ggplot(aes(y = value, x = Origin, group=Origin, color=Origin, fill=Origin)) + geom_boxplot(outlier.shape = NA) + geom_jitter(alpha=0.5) + scale_color_manual(name=&quot;Origin&quot;, breaks=c(&quot;Tame&quot;,&quot;Feral&quot;), values=c(&quot;#6A9AC3&quot;,&quot;#F3B942&quot;)) + scale_fill_manual(name=&quot;Origin&quot;, breaks=c(&quot;Tame&quot;,&quot;Feral&quot;), values=c(&quot;#6A9AC350&quot;,&quot;#F3B94250&quot;)) + facet_wrap(. ~ Location, scales = &quot;fixed&quot;, ncol=6) + coord_cartesian(xlim = c(1, NA)) + theme_classic() + theme( strip.background = element_blank(), panel.grid.minor.x = element_line(size = .1, color = &quot;grey&quot;), axis.title.x = element_blank(), axis.title.y = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1) ) "],["beta-diversity.html", "Chapter 6 Beta diversity", " Chapter 6 Beta diversity load(&quot;data/data.Rdata&quot;) beta_q0n &lt;- genome_counts_filt %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% filter(rowSums(. != 0, na.rm = TRUE) &gt; 0) %&gt;% select_if(~!all(. == 0)) %&gt;% hillpair(., q = 0) beta_q1n &lt;- genome_counts_filt %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% filter(rowSums(. != 0, na.rm = TRUE) &gt; 0) %&gt;% select_if(~!all(. == 0)) %&gt;% hillpair(., q = 1) beta_q1p &lt;- genome_counts_filt %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% filter(rowSums(. != 0, na.rm = TRUE) &gt; 0) %&gt;% select_if(~!all(. == 0)) %&gt;% hillpair(., q = 1, tree = genome_tree) beta_q1f &lt;- genome_counts_filt %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% filter(rowSums(. != 0, na.rm = TRUE) &gt; 0) %&gt;% select_if(~!all(. == 0)) %&gt;% hillpair(., q = 1, dist = dist) 6.0.1 Permanova #Richness betadisper(beta_q0n$C, sample_metadata$Origin) %&gt;% permutest(., pairwise = TRUE) Permutation test for homogeneity of multivariate dispersions Permutation: free Number of permutations: 999 Response: Distances Df Sum Sq Mean Sq F N.Perm Pr(&gt;F) Groups 1 0.00649 0.0064888 0.2231 999 0.634 Residuals 90 2.61727 0.0290808 Pairwise comparisons: (Observed p-value below diagonal, permuted p-value above diagonal) Feral Tame Feral 0.636 Tame 0.63781 adonis2(beta_q0n$C ~ Origin, data = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1n$C))), permutations = 999, strata = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1n$C))) %&gt;% pull(Location)) %&gt;% broom::tidy() %&gt;% tt() tinytable_cv7p7w575ugldiwvvjj0 .table td.tinytable_css_dxjrdyc8qmzsopmptsx1, .table th.tinytable_css_dxjrdyc8qmzsopmptsx1 { border-bottom: solid 0.1em #d3d8dc; } term df SumOfSqs R2 statistic p.value Origin 1 0.360299 0.01814891 1.663594 0.217 Residual 90 19.492078 0.98185109 NA NA Total 91 19.852377 1.00000000 NA NA #Neutral diversity betadisper(beta_q1n$C, sample_metadata$Origin) %&gt;% permutest(., pairwise = TRUE) Permutation test for homogeneity of multivariate dispersions Permutation: free Number of permutations: 999 Response: Distances Df Sum Sq Mean Sq F N.Perm Pr(&gt;F) Groups 1 0.01097 0.010969 0.5763 999 0.457 Residuals 90 1.71289 0.019032 Pairwise comparisons: (Observed p-value below diagonal, permuted p-value above diagonal) Feral Tame Feral 0.467 Tame 0.44974 adonis2(beta_q1n$C ~ Origin, data = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1n$C))), permutations = 999, strata = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1n$C))) %&gt;% pull(Location)) %&gt;% broom::tidy() %&gt;% tt() tinytable_wi28x7p6wb5yh9tygq8y .table td.tinytable_css_7j1efnlpz9u79i4zb8bu, .table th.tinytable_css_7j1efnlpz9u79i4zb8bu { border-bottom: solid 0.1em #d3d8dc; } term df SumOfSqs R2 statistic p.value Origin 1 0.3587603 0.01623493 1.485257 0.297 Residual 90 21.7392877 0.98376507 NA NA Total 91 22.0980479 1.00000000 NA NA #Phylogenetic diversity betadisper(beta_q1p$C, sample_metadata$Origin) %&gt;% permutest(., pairwise = TRUE) Permutation test for homogeneity of multivariate dispersions Permutation: free Number of permutations: 999 Response: Distances Df Sum Sq Mean Sq F N.Perm Pr(&gt;F) Groups 1 0.01235 0.012355 0.6076 999 0.421 Residuals 90 1.83012 0.020335 Pairwise comparisons: (Observed p-value below diagonal, permuted p-value above diagonal) Feral Tame Feral 0.423 Tame 0.43775 adonis2(beta_q1p$C ~ Origin, data = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1n$C))), permutations = 999, strata = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1n$C))) %&gt;% pull(Location)) %&gt;% broom::tidy() %&gt;% tt() tinytable_cl0f2p8dhjb0nvy1z4ml .table td.tinytable_css_jmnyzqj7a3kckac4l6yc, .table th.tinytable_css_jmnyzqj7a3kckac4l6yc { border-bottom: solid 0.1em #d3d8dc; } term df SumOfSqs R2 statistic p.value Origin 1 0.1824935 0.02489257 2.297522 0.163 Residual 90 7.1487493 0.97510743 NA NA Total 91 7.3312427 1.00000000 NA NA #Functional diversity betadisper(beta_q1f$C, sample_metadata$Origin) %&gt;% permutest(., pairwise = TRUE) Permutation test for homogeneity of multivariate dispersions Permutation: free Number of permutations: 999 Response: Distances Df Sum Sq Mean Sq F N.Perm Pr(&gt;F) Groups 1 0.1982 0.198217 2.7199 999 0.097 . Residuals 90 6.5589 0.072877 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 Pairwise comparisons: (Observed p-value below diagonal, permuted p-value above diagonal) Feral Tame Feral 0.104 Tame 0.10259 adonis2(beta_q1f$C ~ Origin, data = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1n$C))), permutations = 999, strata = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1n$C))) %&gt;% pull(Location)) %&gt;% broom::tidy() %&gt;% tt() tinytable_54w8ldsp1x8j35eein22 .table td.tinytable_css_goyb3yjiu4r9a7myc1t7, .table th.tinytable_css_goyb3yjiu4r9a7myc1t7 { border-bottom: solid 0.1em #d3d8dc; } term df SumOfSqs R2 statistic p.value Origin 1 0.3017094 0.02299117 2.117898 0.249 Residual 90 12.8211288 0.97700883 NA NA Total 91 13.1228382 1.00000000 NA NA 6.0.2 Richness diversity plot beta_q0n$S %&gt;% vegan::metaMDS(., trymax = 500, k = 2, trace=0) %&gt;% vegan::scores() %&gt;% as_tibble(., rownames = &quot;sample&quot;) %&gt;% dplyr::left_join(sample_metadata, by = join_by(sample == sample)) %&gt;% group_by(Origin,Location) %&gt;% mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %&gt;% mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %&gt;% ungroup() %&gt;% ggplot(aes(x = NMDS1, y = NMDS2, color = Origin, fill = Origin, shape = as.factor(Location))) + scale_color_manual(name=&quot;Origin&quot;, breaks=c(&quot;Tame&quot;,&quot;Feral&quot;), values=c(&quot;#6A9AC3&quot;,&quot;#F3B942&quot;)) + scale_fill_manual(name=&quot;Origin&quot;, breaks=c(&quot;Tame&quot;,&quot;Feral&quot;), values=c(&quot;#6A9AC350&quot;,&quot;#F3B94250&quot;)) + geom_point(size = 4) + # stat_ellipse(aes(color = beta_q1n_nmds$Groups))+ geom_segment(aes(x = x_cen, y = y_cen, xend = NMDS1, yend = NMDS2), alpha = 0.9) + theme_classic() + theme( axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), axis.title = element_text(size = 20, face = &quot;bold&quot;), axis.text = element_text(face = &quot;bold&quot;, size = 18), panel.background = element_blank(), axis.line = element_line(size = 0.5, linetype = &quot;solid&quot;, colour = &quot;black&quot;), legend.text = element_text(size = 16), legend.title = element_text(size = 18), legend.position = &quot;right&quot;, legend.box = &quot;vertical&quot; ) + labs(shape=&quot;Individual&quot;) 6.0.3 Neutral diversity plot beta_q1n$S %&gt;% vegan::metaMDS(., trymax = 500, k = 2, trace=0) %&gt;% vegan::scores() %&gt;% as_tibble(., rownames = &quot;sample&quot;) %&gt;% dplyr::left_join(sample_metadata, by = join_by(sample == sample)) %&gt;% group_by(Origin,Location) %&gt;% mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %&gt;% mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %&gt;% ungroup() %&gt;% ggplot(aes(x = NMDS1, y = NMDS2, color = Origin, fill = Origin, shape = as.factor(Location))) + scale_color_manual(name=&quot;Origin&quot;, breaks=c(&quot;Tame&quot;,&quot;Feral&quot;), values=c(&quot;#6A9AC3&quot;,&quot;#F3B942&quot;)) + scale_fill_manual(name=&quot;Origin&quot;, breaks=c(&quot;Tame&quot;,&quot;Feral&quot;), values=c(&quot;#6A9AC350&quot;,&quot;#F3B94250&quot;)) + geom_point(size = 4) + # stat_ellipse(aes(color = beta_q1n_nmds$Groups))+ geom_segment(aes(x = x_cen, y = y_cen, xend = NMDS1, yend = NMDS2), alpha = 0.9) + theme_classic() + theme( axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), axis.title = element_text(size = 20, face = &quot;bold&quot;), axis.text = element_text(face = &quot;bold&quot;, size = 18), panel.background = element_blank(), axis.line = element_line(size = 0.5, linetype = &quot;solid&quot;, colour = &quot;black&quot;), legend.text = element_text(size = 16), legend.title = element_text(size = 18), legend.position = &quot;right&quot;, legend.box = &quot;vertical&quot; ) + labs(shape=&quot;Individual&quot;) "],["hmsc-setup.html", "Chapter 7 HMSC setup 7.1 Setup 7.2 Define formulas of the Hmsc model 7.3 Define and Hmsc models 7.4 Define MCMC 7.5 Generate Hmsc executables 7.6 Fit Hmsc models (in Mjolnir HPC)", " Chapter 7 HMSC setup 7.1 Setup load(&quot;data/data.Rdata&quot;) # Random effects data (study design) StudyDesign &lt;- sample_metadata %&gt;% select(sample,Location) %&gt;% rename(location=Location) %&gt;% column_to_rownames(&quot;sample&quot;) %&gt;% mutate(location = factor(location)) # Genome count table (quantitative community data) YData &lt;- read_counts %&gt;% mutate(across(where(is.numeric), ~ . +1 )) %&gt;% #add +1 pseudocount to remove zeros mutate(across(where(is.numeric), ~ . / (genome_metadata$length / 150) )) %&gt;% #transform to genome counts mutate(across(where(is.numeric), ~ log(.) )) %&gt;% #log-transform arrange(genome) %&gt;% column_to_rownames(&quot;genome&quot;) %&gt;% select(all_of(row.names(StudyDesign))) %&gt;% #filter only faecal samples as.data.frame() %&gt;% t() # transpose # Fixed effects data (explanatory variables) XData &lt;- sample_metadata %&gt;% column_to_rownames(&quot;sample&quot;) %&gt;% mutate(logseqdepth=read_counts %&gt;% #total log-sequencing depth select(all_of(row.names(StudyDesign))) %&gt;% colSums() %&gt;% log() ) %&gt;% rename(origin=Origin, sex=F.M) %&gt;% mutate(origin = factor(origin)) %&gt;% mutate(sex = factor(sex)) %&gt;% select(origin, sex, logseqdepth) # Genome phylogeny PData &lt;- genome_tree 7.2 Define formulas of the Hmsc model # Fixed effects formula XFormula = ~origin + sex + logseqdepth # Study design rL.location = HmscRandomLevel(units = levels(StudyDesign$location)) 7.3 Define and Hmsc models #Define models model1 = Hmsc(Y=YData, XData = XData, XFormula = XFormula, studyDesign = StudyDesign, phyloTree = PData, ranLevels=list(&quot;location&quot;=rL.location), distr = &quot;normal&quot;, YScale = TRUE) #Save list of models as an R object. model_list = list(model1=model1) if (!dir.exists(&quot;hmsc&quot;)){dir.create(&quot;hmsc&quot;)} save(model_list, file = &quot;hmsc/hmsc.Rdata&quot;) Upload hmsc/hmsc.Rdata to the HPC respecting the directory structure. 7.4 Define MCMC # How often to sample the MCMC MCMC_samples_list = 250 # The number of MCMC steps between each recording sample MCMC_thin_list = 10 # The number of MCMC chains to use nChains = 4 7.5 Generate Hmsc executables The next chunk generates shell files for every combination of model, MCMC samples and MCMM thinning, ready to be launched as SLURM jobs. modelchains &lt;- expand.grid(model = names(model_list), sample = MCMC_samples_list, thin = MCMC_thin_list) if (!dir.exists(&quot;hmsc&quot;)){dir.create(&quot;hmsc&quot;)} for(i in c(1:nrow(modelchains))){ modelname=as.character(modelchains[i,1]) sample=modelchains[i,2] thin=modelchains[i,3] executablename &lt;- paste0(&quot;hmsc/exe_&quot;,modelname,&quot;_&quot;,sample,&quot;_&quot;,thin,&quot;.sh&quot;) fitname &lt;- paste0(&quot;fit_&quot;,modelname,&quot;_&quot;,sample,&quot;_&quot;,thin,&quot;.Rdata&quot;) convname &lt;- paste0(&quot;conv_&quot;,modelname,&quot;_&quot;,sample,&quot;_&quot;,thin,&quot;.Rdata&quot;) model &lt;- paste0(&#39;model_list$&#39;,modelname) psrf.beta.name &lt;- paste0(&quot;psrf.beta.&quot;,modelname,&quot;_&quot;,sample,&quot;_&quot;,thin) psrf.gamma.name &lt;- paste0(&quot;psrf.gamma.&quot;,modelname,&quot;_&quot;,sample,&quot;_&quot;,thin) psrf.rho.name &lt;- paste0(&quot;psrf.rho.&quot;,modelname,&quot;_&quot;,sample,&quot;_&quot;,thin) jobname &lt;- paste0(&quot;hmsc_&quot;,modelname,&quot;_&quot;,sample,&quot;_&quot;,thin) minutes &lt;- 1000 code &lt;- sprintf(&quot;#!/bin/bash #SBATCH --job-name=%s # Job name #SBATCH --nodes=1 #SBATCH --ntasks=4 # Run on 4 CPUs #SBATCH --mail-user=antton.alberdi@sund.ku.dk #SBATCH --mem=96gb # Job memory request #SBATCH --time=%d # In minutes # Activate conda environment module load mamba/1.3.1 source activate /maps/projects/mjolnir1/people/jpl786/AMAC001_fibre_trial/hmsc/hmsc_env # Run R script Rscript -e &#39; library(tidyverse) library(Hmsc) # Load formulas and data load(\\&quot;hmsc.Rdata\\&quot;) # Declare placeholders modelname = \\&quot;%s\\&quot; model = %s fitname = \\&quot;%s\\&quot; convname = \\&quot;%s\\&quot; sample = %d thin = %d nchains = %d # Run model fitting m = sampleMcmc(hM = model, samples = sample, thin = thin, adaptNf=rep(ceiling(0.4*sample*thin),model$nr), transient = ceiling(0.5*sample*thin), nChains = nchains, nParallel = nchains) # Assess chain convergence mpost = convertToCodaObject(m, spNamesNumbers = c(T,F), covNamesNumbers = c(T,F), Beta = TRUE, Gamma = TRUE, V = FALSE, Sigma = FALSE, Rho = TRUE, Eta = FALSE, Lambda = FALSE, Alpha = FALSE, Omega = FALSE, Psi = FALSE, Delta = FALSE) # Convert to CODA object # Fixed effects assign(paste0(\\&quot;psrf.beta.\\&quot;, modelname,\\&quot;_\\&quot;,sample,\\&quot;_\\&quot;,thin), gelman.diag(mpost$Beta,multivariate=FALSE)$psrf) # Traits assign(paste0(\\&quot;psrf.gamma.\\&quot;, modelname,\\&quot;_\\&quot;,sample,\\&quot;_\\&quot;,thin), gelman.diag(mpost$Gamma,multivariate=FALSE)$psrf) # Phylogeny assign(paste0(\\&quot;psrf.rho.\\&quot;, modelname,\\&quot;_\\&quot;,sample,\\&quot;_\\&quot;,thin), gelman.diag(mpost$Rho,multivariate=FALSE)$psrf) # Write convergence data save(%s, %s, %s, file=convname) # Save model fit object save(m, file=fitname) &#39; &quot;, jobname, minutes, modelname, model, fitname, convname, sample, thin, nChains, psrf.beta.name, psrf.gamma.name, psrf.rho.name) writeLines(code, executablename) } Upload the produced hmsc/exe_XXXXX.sh files to the HPC respecting the directory structure. 7.6 Fit Hmsc models (in Mjolnir HPC) Launch the SLURM jobs by using: #Create and define tmpdir tmpdir=&quot;./tmp&quot; mkdir -p &quot;$tmpdir&quot; export TMPDIR=&quot;$tmpdir&quot; #Or launch them one by one only the ones you want to launch sbatch exe_model1_250_1.sh "],["hmsc-analysis.html", "Chapter 8 HMSC analysis 8.1 Load data 8.2 Variance partitioning 8.3 Posterior estimates 8.4 Correlations 8.5 Predict responses", " Chapter 8 HMSC analysis 8.1 Load data load(&quot;data/data.Rdata&quot;) load(&quot;hmsc/fit_model1_250_10.Rdata&quot;) 8.2 Variance partitioning # Compute variance partitioning varpart=computeVariancePartitioning(m) varpart$vals %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;variable&quot;) %&gt;% pivot_longer(!variable, names_to = &quot;genome&quot;, values_to = &quot;value&quot;) %&gt;% mutate(variable=factor(variable, levels=rev(c(&quot;origin&quot;,&quot;sex&quot;,&quot;logseqdepth&quot;,&quot;Random: location&quot;)))) %&gt;% group_by(variable) %&gt;% summarise(mean=mean(value)*100,sd=sd(value)*100) %&gt;% tt() tinytable_lmzvra6nhk0bhmrxot7y .table td.tinytable_css_s604bcwx1sg940w9wd6g, .table th.tinytable_css_s604bcwx1sg940w9wd6g { border-bottom: solid 0.1em #d3d8dc; } variable mean sd Random: location 37.900015 25.317903 logseqdepth 56.110626 25.796874 sex 4.937460 5.612719 origin 1.051899 1.282563 # Basal tree varpart_tree &lt;- genome_tree #Varpart table varpart_table &lt;- varpart$vals %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;variable&quot;) %&gt;% pivot_longer(!variable, names_to = &quot;genome&quot;, values_to = &quot;value&quot;) %&gt;% mutate(genome=factor(genome, levels=rev(varpart_tree$tip.label))) %&gt;% mutate(variable=factor(variable, levels=rev(c(&quot;origin&quot;,&quot;sex&quot;,&quot;logseqdepth&quot;,&quot;Random: location&quot;)))) #Phylums phylum_colors &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;))%&gt;% right_join(genome_metadata, by=join_by(phylum == phylum)) %&gt;% filter(genome %in% varpart_tree$tip.label) %&gt;% arrange(match(genome, varpart_tree$tip.label)) %&gt;% mutate(phylum = factor(phylum, levels = unique(phylum))) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% select(phylum) colors_alphabetic &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;))%&gt;% right_join(genome_metadata, by=join_by(phylum == phylum)) %&gt;% filter(genome %in% varpart_tree$tip.label) %&gt;% arrange(match(genome, varpart_tree$tip.label)) %&gt;% select(phylum, colors) %&gt;% unique() %&gt;% arrange(phylum) %&gt;% select(colors) %&gt;% pull() # Basal ggtree varpart_tree &lt;- varpart_tree %&gt;% force.ultrametric(.,method=&quot;extend&quot;) %&gt;% ggtree(., size = 0.3) *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** # Add phylum colors next to the tree tips varpart_tree &lt;- gheatmap(varpart_tree, phylum_colors, offset=-0.2, width=0.1, colnames=FALSE) + scale_fill_manual(values=colors_alphabetic)+ labs(fill=&quot;Phylum&quot;) #Reset fill scale to use a different colour profile in the heatmap varpart_tree &lt;- varpart_tree + new_scale_fill() # Add variance stacked barplot vertical_tree &lt;- varpart_tree + scale_fill_manual(values=c(&quot;#506a96&quot;,&quot;#cccccc&quot;,&quot;#be3e2b&quot;,&quot;#f6de6c&quot;))+ geom_fruit( data=varpart_table, geom=geom_bar, mapping = aes(x=value, y=genome, fill=variable, group=variable), pwidth = 2, offset = 0.05, width= 1, orientation=&quot;y&quot;, stat=&quot;identity&quot;)+ labs(fill=&quot;Variable&quot;) vertical_tree 8.3 Posterior estimates # Select desired support threshold support=0.9 negsupport=1-support # Basal tree postestimates_tree &lt;- genome_tree # Posterior estimate table post_beta &lt;- getPostEstimate(hM=m, parName=&quot;Beta&quot;)$support %&gt;% as.data.frame() %&gt;% mutate(variable=m$covNames) %&gt;% pivot_longer(!variable, names_to = &quot;genome&quot;, values_to = &quot;value&quot;) %&gt;% mutate(genome=factor(genome, levels=rev(postestimates_tree$tip.label))) %&gt;% mutate(value = case_when( value &gt;= support ~ &quot;Positive&quot;, value &lt;= negsupport ~ &quot;Negative&quot;, TRUE ~ &quot;Neutral&quot;)) %&gt;% mutate(value=factor(value, levels=c(&quot;Positive&quot;,&quot;Neutral&quot;,&quot;Negative&quot;))) %&gt;% pivot_wider(names_from = variable, values_from = value) %&gt;% #select(genome,sp_vulgaris,area_semi,area_urban,sp_vulgarisxarea_semi,sp_vulgarisxarea_urban,season_spring,season_winter,sp_vulgarisxseason_spring,sp_vulgarisxseason_winter) %&gt;% column_to_rownames(var=&quot;genome&quot;) #Phylums phylum_colors &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) %&gt;% right_join(genome_metadata, by=join_by(phylum == phylum)) %&gt;% filter(genome %in% postestimates_tree$tip.label) %&gt;% arrange(match(genome, postestimates_tree$tip.label)) %&gt;% mutate(phylum = factor(phylum, levels = unique(phylum))) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% select(phylum) colors_alphabetic &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) %&gt;% right_join(genome_metadata, by=join_by(phylum == phylum)) %&gt;% filter(genome %in% postestimates_tree$tip.label) %&gt;% arrange(match(genome, postestimates_tree$tip.label)) %&gt;% select(phylum, colors) %&gt;% unique() %&gt;% arrange(phylum) %&gt;% select(colors) %&gt;% pull() # Basal ggtree postestimates_tree &lt;- postestimates_tree %&gt;% force.ultrametric(.,method=&quot;extend&quot;) %&gt;% ggtree(., size = 0.3) *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** #Add phylum colors next to the tree tips postestimates_tree &lt;- gheatmap(postestimates_tree, phylum_colors, offset=-0.2, width=0.1, colnames=FALSE) + scale_fill_manual(values=colors_alphabetic)+ labs(fill=&quot;Phylum&quot;) #Reset fill scale to use a different colour profile in the heatmap postestimates_tree &lt;- postestimates_tree + new_scale_fill() # Add posterior significant heatmap postestimates_tree &lt;- gheatmap(postestimates_tree, post_beta, offset=0, width=0.5, colnames=TRUE, colnames_position=&quot;top&quot;,colnames_angle=90, colnames_offset_y=1, hjust=0) + scale_fill_manual(values=c(&quot;#be3e2b&quot;,&quot;#f4f4f4&quot;,&quot;#b2b530&quot;))+ labs(fill=&quot;Trend&quot;) postestimates_tree + vexpand(.25, 1) # expand top 8.3.1 Positively associated genomes getPostEstimate(hM=m, parName=&quot;Beta&quot;)$support %&gt;% as.data.frame() %&gt;% mutate(variable=m$covNames) %&gt;% pivot_longer(!variable, names_to = &quot;genome&quot;, values_to = &quot;value&quot;) %&gt;% mutate(trend = case_when( value &gt;= support ~ &quot;Positive&quot;, value &lt;= negsupport ~ &quot;Negative&quot;, TRUE ~ &quot;Neutral&quot;)) %&gt;% filter(variable==&quot;originTame&quot;, trend==&quot;Positive&quot;) %&gt;% arrange(-value) %&gt;% left_join(genome_metadata,by=join_by(genome==genome)) %&gt;% select(genome,phylum,class,order,family,species,value) %&gt;% arrange(phylum, class, family)%&gt;% tt() tinytable_t8op8lx0owsv2tp24muu .table td.tinytable_css_fh9inpxl11li238edsnx, .table th.tinytable_css_fh9inpxl11li238edsnx { border-bottom: solid 0.1em #d3d8dc; } genome phylum class order family species value bin_CaboVerde.50 Actinomycetota Actinomycetia Actinomycetales Actinomycetaceae NA 0.953 bin_Aruba.25 Actinomycetota Actinomycetia Actinomycetales Bifidobacteriaceae Bifidobacterium pseudocatenulatum 0.995 bin_Aruba.2 Actinomycetota Actinomycetia Actinomycetales Bifidobacteriaceae Bifidobacterium adolescentis 0.994 bin_Aruba.6 Actinomycetota Actinomycetia Actinomycetales Bifidobacteriaceae Bifidobacterium longum 0.985 bin_Denmark.14 Actinomycetota Actinomycetia Actinomycetales Bifidobacteriaceae Bifidobacterium gallinarum 0.950 bin_Aruba.47 Actinomycetota Actinomycetia Mycobacteriales Mycobacteriaceae NA 0.964 bin_Aruba.57 Actinomycetota Actinomycetia Mycobacteriales Mycobacteriaceae Corynebacterium pyruviciproducens 0.931 bin_Aruba.51 Actinomycetota Coriobacteriia Coriobacteriales Atopobiaceae Parolsenella sp900544655 0.969 bin_Denmark.44 Actinomycetota Coriobacteriia Coriobacteriales Atopobiaceae UBA7748 sp900314535 0.951 bin_Aruba.14 Actinomycetota Coriobacteriia Coriobacteriales Coriobacteriaceae Collinsella stercoris 1.000 bin_Denmark.4 Actinomycetota Coriobacteriia Coriobacteriales Coriobacteriaceae Collinsella stercoris 1.000 bin_Aruba.21 Actinomycetota Coriobacteriia Coriobacteriales Coriobacteriaceae NA 0.999 bin_Brazil.61 Actinomycetota Coriobacteriia Coriobacteriales Coriobacteriaceae Collinsella tanakaei 0.998 bin_Aruba.39 Actinomycetota Coriobacteriia Coriobacteriales Coriobacteriaceae Collinsella sp902362275 0.992 bin_Spain.84 Actinomycetota Coriobacteriia Coriobacteriales Coriobacteriaceae Collinsella sp900555555 0.992 bin_Brazil.151 Actinomycetota Coriobacteriia Coriobacteriales Coriobacteriaceae Collinsella intestinalis 0.991 bin_Denmark.127 Actinomycetota Coriobacteriia Coriobacteriales Coriobacteriaceae Collinsella sp900548365 0.991 bin_Denmark.17 Actinomycetota Coriobacteriia Coriobacteriales Coriobacteriaceae Collinsella bouchesdurhonensis 0.983 bin_Brazil.81 Bacillota Bacilli RFN20 CAG-826 NA 0.907 bin_Brazil.109 Bacillota_A Clostridia Oscillospirales Butyricicoccaceae AM07-15 sp003477405 0.936 bin_Aruba.28 Bacillota_A Clostridia Oscillospirales Oscillospiraceae NA 0.995 bin_Malaysia.9 Bacillota_A Clostridia Oscillospirales Oscillospiraceae Dysosmobacter welbionis 0.986 bin_Malaysia.116 Bacillota_A Clostridia Oscillospirales Oscillospiraceae Flavonifractor plautii 0.981 bin_Malaysia.34 Bacillota_A Clostridia Oscillospirales Oscillospiraceae Lawsonibacter sp000177015 0.954 bin_Aruba.54 Bacillota_A Clostridia Tissierellales Peptoniphilaceae NA 0.959 bin_CaboVerde.35 Bacillota_A Clostridia Tissierellales Peptoniphilaceae NA 0.930 bin_Aruba.36 Bacillota_A Clostridia Tissierellales Peptoniphilaceae Peptoniphilus_C sp902363535 0.913 bin_Aruba.52 Bacillota_A Clostridia Tissierellales Peptoniphilaceae NA 0.906 bin_Malaysia.26 Bacillota_A Clostridia Oscillospirales Ruminococcaceae NA 0.976 bin_Aruba.29 Bacillota_A Clostridia Oscillospirales Ruminococcaceae Gemmiger variabilis_C 0.941 bin_Malaysia.103 Bacillota_C Negativicutes Acidaminococcales Acidaminococcaceae Acidaminococcus intestini 0.942 bin_Malaysia.8 Bacillota_C Negativicutes Veillonellales Dialisteraceae Dialister sp900543165 0.981 bin_Denmark.60 Bacillota_C Negativicutes Veillonellales Dialisteraceae Allisonella histaminiformans 0.938 bin_Aruba.64 Bacillota_C Negativicutes Veillonellales Megasphaeraceae Megasphaera sp000417505 0.970 bin_Brazil.58 Bacillota_C Negativicutes Veillonellales Megasphaeraceae Megasphaera elsdenii 0.969 bin_CaboVerde.38 Bacillota_C Negativicutes Veillonellales Megasphaeraceae Megasphaera sp000417505 0.961 bin_Malaysia.81 Bacillota_C Negativicutes Veillonellales Megasphaeraceae Megasphaera stantonii 0.943 bin_Malaysia.96 Bacillota_C Negativicutes Veillonellales Megasphaeraceae Caecibacter sp003467125 0.919 bin_Brazil.163 Bacteroidota Bacteroidia Bacteroidales Bacteroidaceae Prevotella lascolaii 0.992 bin_CaboVerde.18 Bacteroidota Bacteroidia Bacteroidales Bacteroidaceae Prevotella copri 0.981 bin_Aruba.10 Bacteroidota Bacteroidia Bacteroidales Bacteroidaceae Prevotella sp900544825 0.978 bin_Brazil.5 Bacteroidota Bacteroidia Bacteroidales Bacteroidaceae Prevotella sp900540415 0.929 bin_Spain.21 Bacteroidota Bacteroidia Bacteroidales Bacteroidaceae Phocaeicola coprophilus 0.929 bin_Malaysia.18 Bacteroidota Bacteroidia Bacteroidales Bacteroidaceae Prevotellamassilia sp000437675 0.924 bin_Malaysia.117 Bacteroidota Bacteroidia Bacteroidales Bacteroidaceae Prevotellamassilia sp900541335 0.919 bin_Malaysia.77 Bacteroidota Bacteroidia Bacteroidales Bacteroidaceae Phocaeicola sp900542985 0.913 bin_Brazil.75 Campylobacterota Campylobacteria Campylobacterales Helicobacteraceae NA 0.964 bin_Malaysia.61 Campylobacterota Campylobacteria Campylobacterales Helicobacteraceae Helicobacter_C labetoulli 0.964 bin_Brazil.128 Campylobacterota Campylobacteria Campylobacterales Helicobacteraceae NA 0.963 bin_Brazil.70 Desulfobacterota Desulfovibrionia Desulfovibrionales Desulfovibrionaceae Mailhella sp003150275 0.944 bin_Brazil.146 Pseudomonadota Alphaproteobacteria RF32 CAG-239 CAG-495 sp001917125 0.969 bin_Brazil.9 Pseudomonadota Alphaproteobacteria RF32 CAG-239 CAG-495 sp000436375 0.919 bin_Aruba.15 Pseudomonadota Gammaproteobacteria Burkholderiales Burkholderiaceae NA 0.963 bin_Brazil.51 Pseudomonadota Gammaproteobacteria Burkholderiales Burkholderiaceae Sutterella wadsworthensis_A 0.963 bin_Spain.43 Pseudomonadota Gammaproteobacteria Burkholderiales Burkholderiaceae CAG-521 sp000437635 0.959 bin_Brazil.64 Pseudomonadota Gammaproteobacteria Burkholderiales Burkholderiaceae NA 0.948 bin_Brazil.92 Pseudomonadota Gammaproteobacteria Burkholderiales Burkholderiaceae CAG-521 sp000437635 0.948 bin_Brazil.15 Pseudomonadota Gammaproteobacteria Burkholderiales Burkholderiaceae NA 0.930 bin_CaboVerde.33 Pseudomonadota Gammaproteobacteria Enterobacterales Succinivibrionaceae Anaerobiospirillum sp900543125 0.995 bin_Brazil.82 Pseudomonadota Gammaproteobacteria Enterobacterales Succinivibrionaceae Anaerobiospirillum succiniciproducens 0.990 bin_CaboVerde.55 Pseudomonadota Gammaproteobacteria Enterobacterales Succinivibrionaceae Anaerobiospirillum_A thomasii 0.939 8.3.2 Negatively associated genomes getPostEstimate(hM=m, parName=&quot;Beta&quot;)$support %&gt;% as.data.frame() %&gt;% mutate(variable=m$covNames) %&gt;% pivot_longer(!variable, names_to = &quot;genome&quot;, values_to = &quot;value&quot;) %&gt;% mutate(trend = case_when( value &gt;= support ~ &quot;Positive&quot;, value &lt;= negsupport ~ &quot;Negative&quot;, TRUE ~ &quot;Neutral&quot;)) %&gt;% filter(variable==&quot;originTame&quot;, trend==&quot;Negative&quot;) %&gt;% arrange(value) %&gt;% left_join(genome_metadata,by=join_by(genome==genome)) %&gt;% select(genome,phylum,class,order,family,species,value) %&gt;% arrange(phylum,class,family)%&gt;% tt() tinytable_y7vfte7rqpxogoizoe7g .table td.tinytable_css_xk4ka1vlk9j2t60fc993, .table th.tinytable_css_xk4ka1vlk9j2t60fc993 { border-bottom: solid 0.1em #d3d8dc; } genome phylum class order family species value bin_Denmark.27 Bacillota Bacilli Lactobacillales Enterococcaceae Enterococcus_B hirae 0.000 bin_Brazil.12 Bacillota Bacilli Lactobacillales Enterococcaceae Enterococcus faecalis 0.001 bin_Brazil.170 Bacillota Bacilli Lactobacillales Enterococcaceae NA 0.014 bin_CaboVerde.24 Bacillota Bacilli Lactobacillales Enterococcaceae Enterococcus_E cecorum 0.020 bin_CaboVerde.16 Bacillota Bacilli Lactobacillales Lactobacillaceae Limosilactobacillus reuteri 0.000 bin_Denmark.56 Bacillota Bacilli Lactobacillales Lactobacillaceae Levilactobacillus brevis 0.000 bin_Malaysia.72 Bacillota Bacilli Lactobacillales Lactobacillaceae Limosilactobacillus reuteri 0.000 bin_CaboVerde.60 Bacillota Bacilli Lactobacillales Lactobacillaceae Ligilactobacillus agilis 0.001 bin_Malaysia.127 Bacillota Bacilli Lactobacillales Lactobacillaceae Ligilactobacillus agilis 0.001 bin_Denmark.61 Bacillota Bacilli Lactobacillales Lactobacillaceae Latilactobacillus sakei 0.003 bin_Malaysia.35 Bacillota Bacilli Lactobacillales Lactobacillaceae Ligilactobacillus animalis 0.003 bin_Malaysia.4 Bacillota Bacilli Lactobacillales Lactobacillaceae Ligilactobacillus ruminis 0.035 bin_CaboVerde.14 Bacillota Bacilli Lactobacillales Lactobacillaceae Lactobacillus acidophilus 0.067 bin_Aruba.18 Bacillota Bacilli Lactobacillales Streptococcaceae Streptococcus lutetiensis 0.001 bin_Brazil.22 Bacillota Bacilli Lactobacillales Streptococcaceae Streptococcus pasteurianus 0.001 bin_Denmark.117 Bacillota Bacilli Lactobacillales Streptococcaceae Lactococcus garvieae 0.001 bin_Denmark.113 Bacillota Bacilli Lactobacillales Streptococcaceae Streptococcus alactolyticus 0.002 bin_Brazil.69 Bacillota_A Clostridia Oscillospirales Acutalibacteraceae Clostridium_A leptum 0.097 bin_Denmark.93 Bacillota_A Clostridia Lachnospirales Anaerotignaceae Anaerotignum sp001304995 0.074 bin_CaboVerde.3 Bacillota_A Clostridia Clostridiales Clostridiaceae Clostridium_P perfringens 0.000 bin_Denmark.42 Bacillota_A Clostridia Clostridiales Clostridiaceae Clostridium_P perfringens 0.000 bin_Brazil.136 Bacillota_A Clostridia Clostridiales Clostridiaceae Clostridium thermobutyricum 0.041 bin_Brazil.3 Bacillota_A Clostridia Lachnospirales Lachnospiraceae Faecalimonas sp900555395 0.026 bin_Brazil.89 Bacillota_A Clostridia Lachnospirales Lachnospiraceae Faecalimonas sp900550235 0.034 bin_Denmark.63 Bacillota_A Clostridia Lachnospirales Lachnospiraceae Anaerostipes hadrus 0.040 bin_Denmark.19 Bacillota_A Clostridia Lachnospirales Lachnospiraceae Faecalimonas sp900556835 0.052 bin_Denmark.118 Bacillota_A Clostridia Lachnospirales Lachnospiraceae Dorea_A longicatena 0.067 bin_Malaysia.108 Bacillota_A Clostridia Lachnospirales Lachnospiraceae NA 0.081 bin_Brazil.113 Bacillota_A Clostridia Lachnospirales Lachnospiraceae Anaerobutyricum sp900754855 0.095 bin_Denmark.50 Bacillota_A Clostridia Peptostreptococcales Peptostreptococcaceae Peptacetobacter sp900539645 0.053 bin_Brazil.107 Bacillota_A Clostridia Monoglobales_A UBA1381 CAG-41 sp900066215 0.016 bin_Brazil.159 Fusobacteriota Fusobacteriia Fusobacteriales Fusobacteriaceae Fusobacterium_B sp900541465 0.040 bin_Brazil.140 Fusobacteriota Fusobacteriia Fusobacteriales Fusobacteriaceae Fusobacterium_A sp900543175 0.046 bin_Malaysia.6 Fusobacteriota Fusobacteriia Fusobacteriales Fusobacteriaceae Fusobacterium_B sp900545035 0.088 8.3.3 Estimate - support plot estimate &lt;- getPostEstimate(hM=m, parName=&quot;Beta&quot;)$mean %&gt;% as.data.frame() %&gt;% mutate(variable=m$covNames) %&gt;% filter(variable==&quot;originTame&quot;) %&gt;% pivot_longer(!variable, names_to = &quot;genome&quot;, values_to = &quot;mean&quot;) %&gt;% select(genome,mean) support &lt;- getPostEstimate(hM=m, parName=&quot;Beta&quot;)$support %&gt;% as.data.frame() %&gt;% mutate(variable=m$covNames) %&gt;% filter(variable==&quot;originTame&quot;) %&gt;% pivot_longer(!variable, names_to = &quot;genome&quot;, values_to = &quot;support&quot;) %&gt;% select(genome,support) phylum_colors &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% right_join(genome_metadata, by=join_by(phylum == phylum)) %&gt;% filter(genome %in% estimate$genome) %&gt;% arrange(match(genome, estimate$genome)) %&gt;% select(phylum, colors) %&gt;% unique() %&gt;% arrange(phylum) %&gt;% select(colors) %&gt;% pull() Rows: 202 Columns: 2 ── Column specification ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (2): phylum, colors ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. inner_join(estimate,support,by=join_by(genome==genome)) %&gt;% mutate(significance=ifelse(support &gt;= 0.9 | support &lt;= 0.1,1,0)) %&gt;% mutate(support=ifelse(mean&lt;0,1-support,support)) %&gt;% left_join(genome_metadata, by = join_by(genome == genome)) %&gt;% mutate(phylum = ifelse(support &gt; 0.9, phylum, NA)) %&gt;% ggplot(aes(x=mean,y=support,color=phylum))+ geom_point(alpha=0.7, shape=16, size=3)+ scale_color_manual(values = phylum_colors) + geom_vline(xintercept = 0) + xlim(c(-0.4,0.4)) + labs(x = &quot;Beta regression coefficient&quot;, y = &quot;Posterior probability&quot;) + theme_minimal()+ theme(legend.position = &quot;none&quot;) 8.4 Correlations #Compute the residual correlation matrix OmegaCor = computeAssociations(m) # Refernece tree (for sorting genomes) genome_tree_subset &lt;- genome_tree %&gt;% keep.tip(., tip=m$spNames) #Co-occurrence matrix at the animal level supportLevel = 0.95 toPlot = ((OmegaCor[[1]]$support&gt;supportLevel) + (OmegaCor[[1]]$support&lt;(1-supportLevel))&gt;0)*OmegaCor[[1]]$mean matrix &lt;- toPlot %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;genome1&quot;) %&gt;% pivot_longer(!genome1, names_to = &quot;genome2&quot;, values_to = &quot;cor&quot;) %&gt;% mutate(genome1= factor(genome1, levels=genome_tree_subset$tip.label)) %&gt;% mutate(genome2= factor(genome2, levels=genome_tree_subset$tip.label)) %&gt;% ggplot(aes(x = genome1, y = genome2, fill = cor)) + geom_tile() + scale_fill_gradient2(low = &quot;#be3e2b&quot;, mid = &quot;#f4f4f4&quot;, high = &quot;#b2b530&quot;)+ theme_void() htree &lt;- genome_tree_subset %&gt;% force.ultrametric(.,method=&quot;extend&quot;) %&gt;% ggtree(.) *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** vtree &lt;- genome_tree_subset %&gt;% force.ultrametric(.,method=&quot;extend&quot;) %&gt;% ggtree(.) *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** #create composite figure grid.arrange(grobs = list(matrix,vtree), layout_matrix = rbind(c(2,1,1,1,1,1,1,1,1,1,1,1), c(2,1,1,1,1,1,1,1,1,1,1,1), c(2,1,1,1,1,1,1,1,1,1,1,1), c(2,1,1,1,1,1,1,1,1,1,1,1), c(2,1,1,1,1,1,1,1,1,1,1,1), c(2,1,1,1,1,1,1,1,1,1,1,1), c(2,1,1,1,1,1,1,1,1,1,1,1), c(2,1,1,1,1,1,1,1,1,1,1,1), c(2,1,1,1,1,1,1,1,1,1,1,1), c(2,1,1,1,1,1,1,1,1,1,1,1), c(2,1,1,1,1,1,1,1,1,1,1,1))) 8.5 Predict responses # Select modelchain of interest load(&quot;hmsc/fit_model1_250_10.Rdata&quot;) gradient = c(&quot;domestic&quot;,&quot;feral&quot;) gradientlength = length(gradient) #Treatment-specific gradient predictions pred &lt;- constructGradient(m, focalVariable = &quot;origin&quot;, non.focalVariables = list(logseqdepth=list(1),location=list(1))) %&gt;% predict(m, Gradient = ., expected = TRUE) %&gt;% do.call(rbind,.) %&gt;% as.data.frame() %&gt;% mutate(origin=rep(gradient,1000)) %&gt;% pivot_longer(!origin,names_to = &quot;genome&quot;, values_to = &quot;value&quot;) # weights: 9 (4 variable) initial value 101.072331 final value 91.392443 converged 8.5.0.1 Element level elements_table &lt;- genome_gifts %&gt;% to.elements(., GIFT_db) %&gt;% as.data.frame() community_elements &lt;- pred %&gt;% group_by(origin, genome) %&gt;% mutate(row_id = row_number()) %&gt;% pivot_wider(names_from = genome, values_from = value) %&gt;% ungroup() %&gt;% group_split(row_id) %&gt;% as.list() %&gt;% lapply(., FUN = function(x){x %&gt;% select(-row_id) %&gt;% column_to_rownames(var = &quot;origin&quot;) %&gt;% as.data.frame() %&gt;% exp() %&gt;% t() %&gt;% tss() %&gt;% to.community(elements_table,.,GIFT_db) %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;origin&quot;) }) calculate_slope &lt;- function(x) { lm_fit &lt;- lm(unlist(x) ~ seq_along(unlist(x))) coef(lm_fit)[2] } element_predictions &lt;- map_dfc(community_elements, function(mat) { mat %&gt;% column_to_rownames(var = &quot;origin&quot;) %&gt;% t() %&gt;% as.data.frame() %&gt;% rowwise() %&gt;% mutate(slope = calculate_slope(c_across(everything()))) %&gt;% select(slope) }) %&gt;% t() %&gt;% as.data.frame() %&gt;% set_names(colnames(community_elements[[1]])[-1]) %&gt;% rownames_to_column(var=&quot;iteration&quot;) %&gt;% pivot_longer(!iteration, names_to=&quot;trait&quot;,values_to=&quot;value&quot;) %&gt;% group_by(trait) %&gt;% summarise(mean=mean(value), p1 = quantile(value, probs = 0.1), p9 = quantile(value, probs = 0.9), positive_support = sum(value &gt; 0)/1000, negative_support = sum(value &lt; 0)/1000) %&gt;% arrange(-positive_support) 8.5.1 Positive associated functions at element level # Positively associated unique_funct_db&lt;- GIFT_db[c(2,4,5,6)] %&gt;% distinct(Code_element, .keep_all = TRUE) element_predictions %&gt;% filter(mean &gt;0) %&gt;% arrange(-positive_support) %&gt;% filter(positive_support&gt;=0.9) %&gt;% left_join(unique_funct_db, by = join_by(trait == Code_element))%&gt;% arrange(Domain,Function)%&gt;% tt() tinytable_n6vx5v7xjc1cpnt9t5ru .table td.tinytable_css_vexah3mf9ve7hiewikou, .table th.tinytable_css_vexah3mf9ve7hiewikou { border-bottom: solid 0.1em #d3d8dc; } trait mean p1 p9 positive_support negative_support Domain Function Element B0103 0.008420823 2.626456e-04 0.016754391 0.905 0.095 Biosynthesis Nucleic acid biosynthesis UDP/UTP D0507 0.003735191 9.899970e-05 0.007310791 0.904 0.096 Degradation Amino acid degradation Leucine D0504 0.004226231 9.114562e-05 0.009450883 0.903 0.097 Degradation Amino acid degradation Methionine D0906 0.003682461 1.514122e-04 0.008065094 0.924 0.076 Degradation Antibiotic degradation Fosfomycin D0205 0.012922091 2.335082e-03 0.024273773 0.953 0.047 Degradation Polysaccharide degradation Pectin D0208 0.010662274 1.860511e-03 0.019350330 0.952 0.048 Degradation Polysaccharide degradation Mixed-Linkage glucans element_predictions %&gt;% filter(mean &lt;0) %&gt;% arrange(-negative_support) %&gt;% filter(negative_support&gt;=0.9) %&gt;% left_join(unique_funct_db, by = join_by(trait == Code_element))%&gt;% arrange(Domain,Function)%&gt;% tt() tinytable_bmqwj2f6fola3yvzlhhp .table td.tinytable_css_npp8qjq7m6fezee93l5q, .table th.tinytable_css_npp8qjq7m6fezee93l5q { border-bottom: solid 0.1em #d3d8dc; } trait mean p1 p9 positive_support negative_support Domain Function Element B0219 -0.004120762 -0.009744587 -1.868946e-04 0.050 0.950 Biosynthesis Amino acid biosynthesis GABA B0214 -0.021577028 -0.038403623 -4.433048e-03 0.074 0.926 Biosynthesis Amino acid biosynthesis Glutamate B0302 -0.004917799 -0.010722576 -5.556478e-04 0.038 0.962 Biosynthesis Amino acid derivative biosynthesis Betaine B0303 -0.011927718 -0.021531333 -2.594417e-03 0.047 0.953 Biosynthesis Amino acid derivative biosynthesis Ectoine B0310 -0.013020080 -0.024236082 -2.725058e-03 0.049 0.951 Biosynthesis Amino acid derivative biosynthesis Tryptamine B0804 -0.016958261 -0.030419517 -3.571889e-03 0.046 0.954 Biosynthesis Aromatic compound biosynthesis Dipicolinate B0603 -0.016693917 -0.032785292 -2.143866e-03 0.075 0.925 Biosynthesis Organic anion biosynthesis Citrate B0601 -0.009211442 -0.018587149 -6.128318e-04 0.086 0.914 Biosynthesis Organic anion biosynthesis Succinate B0401 -0.012664870 -0.025563091 -1.488164e-03 0.068 0.932 Biosynthesis SCFA biosynthesis Acetate B0709 -0.002034555 -0.003593370 -5.969023e-04 0.037 0.963 Biosynthesis Vitamin biosynthesis Tocopherol/tocotorienol (E) D0517 -0.004755747 -0.007913638 -1.298494e-03 0.039 0.961 Degradation Amino acid degradation Ornithine D0508 -0.003383071 -0.007608920 -2.571448e-04 0.079 0.921 Degradation Amino acid degradation Lysine D0903 -0.004087384 -0.009734013 -1.710586e-04 0.049 0.951 Degradation Antibiotic degradation Cephalosporin D0908 -0.015499421 -0.028018262 -2.423208e-03 0.078 0.922 Degradation Antibiotic degradation Macrolide D0601 -0.009230488 -0.017530385 -2.039594e-03 0.048 0.952 Degradation Nitrogen compound degradation Nitrate D0611 -0.004087384 -0.009734013 -1.710586e-04 0.049 0.951 Degradation Nitrogen compound degradation Phenylethylamine D0603 -0.001955518 -0.003904335 -3.795561e-04 0.056 0.944 Degradation Nitrogen compound degradation Urate D0610 -0.003048145 -0.004839064 -6.329848e-04 0.058 0.942 Degradation Nitrogen compound degradation Methylamine D0606 -0.005705653 -0.011515578 -5.139586e-04 0.080 0.920 Degradation Nitrogen compound degradation Allantoin D0612 -0.001780746 -0.003125158 -1.081594e-05 0.100 0.900 Degradation Nitrogen compound degradation Hypotaurine D0801 -0.001776518 -0.002408138 -1.002935e-04 0.012 0.988 Degradation Xenobiotic degradation Toluene D0802 -0.001776518 -0.002408138 -1.002935e-04 0.012 0.988 Degradation Xenobiotic degradation Xylene D0817 -0.004989036 -0.010895021 -5.678925e-04 0.049 0.951 Degradation Xenobiotic degradation Trans-cinnamate D0807 -0.004190774 -0.008810214 -6.183065e-04 0.050 0.950 Degradation Xenobiotic degradation Catechol D0816 -0.005758637 -0.012049341 -4.942859e-04 0.082 0.918 Degradation Xenobiotic degradation Phenylacetate 8.5.2 Negatively associated functions at element level element_predictions %&gt;% filter(mean &lt;0) %&gt;% arrange(-negative_support) %&gt;% filter(negative_support&gt;=0.9) %&gt;% left_join(unique_funct_db, by = join_by(trait == Code_element))%&gt;% arrange(Domain,Function)%&gt;% tt() tinytable_toah5wfy53ns8qm72cf8 .table td.tinytable_css_oh5xvid2gdyjhnfjodad, .table th.tinytable_css_oh5xvid2gdyjhnfjodad { border-bottom: solid 0.1em #d3d8dc; } trait mean p1 p9 positive_support negative_support Domain Function Element B0219 -0.004120762 -0.009744587 -1.868946e-04 0.050 0.950 Biosynthesis Amino acid biosynthesis GABA B0214 -0.021577028 -0.038403623 -4.433048e-03 0.074 0.926 Biosynthesis Amino acid biosynthesis Glutamate B0302 -0.004917799 -0.010722576 -5.556478e-04 0.038 0.962 Biosynthesis Amino acid derivative biosynthesis Betaine B0303 -0.011927718 -0.021531333 -2.594417e-03 0.047 0.953 Biosynthesis Amino acid derivative biosynthesis Ectoine B0310 -0.013020080 -0.024236082 -2.725058e-03 0.049 0.951 Biosynthesis Amino acid derivative biosynthesis Tryptamine B0804 -0.016958261 -0.030419517 -3.571889e-03 0.046 0.954 Biosynthesis Aromatic compound biosynthesis Dipicolinate B0603 -0.016693917 -0.032785292 -2.143866e-03 0.075 0.925 Biosynthesis Organic anion biosynthesis Citrate B0601 -0.009211442 -0.018587149 -6.128318e-04 0.086 0.914 Biosynthesis Organic anion biosynthesis Succinate B0401 -0.012664870 -0.025563091 -1.488164e-03 0.068 0.932 Biosynthesis SCFA biosynthesis Acetate B0709 -0.002034555 -0.003593370 -5.969023e-04 0.037 0.963 Biosynthesis Vitamin biosynthesis Tocopherol/tocotorienol (E) D0517 -0.004755747 -0.007913638 -1.298494e-03 0.039 0.961 Degradation Amino acid degradation Ornithine D0508 -0.003383071 -0.007608920 -2.571448e-04 0.079 0.921 Degradation Amino acid degradation Lysine D0903 -0.004087384 -0.009734013 -1.710586e-04 0.049 0.951 Degradation Antibiotic degradation Cephalosporin D0908 -0.015499421 -0.028018262 -2.423208e-03 0.078 0.922 Degradation Antibiotic degradation Macrolide D0601 -0.009230488 -0.017530385 -2.039594e-03 0.048 0.952 Degradation Nitrogen compound degradation Nitrate D0611 -0.004087384 -0.009734013 -1.710586e-04 0.049 0.951 Degradation Nitrogen compound degradation Phenylethylamine D0603 -0.001955518 -0.003904335 -3.795561e-04 0.056 0.944 Degradation Nitrogen compound degradation Urate D0610 -0.003048145 -0.004839064 -6.329848e-04 0.058 0.942 Degradation Nitrogen compound degradation Methylamine D0606 -0.005705653 -0.011515578 -5.139586e-04 0.080 0.920 Degradation Nitrogen compound degradation Allantoin D0612 -0.001780746 -0.003125158 -1.081594e-05 0.100 0.900 Degradation Nitrogen compound degradation Hypotaurine D0801 -0.001776518 -0.002408138 -1.002935e-04 0.012 0.988 Degradation Xenobiotic degradation Toluene D0802 -0.001776518 -0.002408138 -1.002935e-04 0.012 0.988 Degradation Xenobiotic degradation Xylene D0817 -0.004989036 -0.010895021 -5.678925e-04 0.049 0.951 Degradation Xenobiotic degradation Trans-cinnamate D0807 -0.004190774 -0.008810214 -6.183065e-04 0.050 0.950 Degradation Xenobiotic degradation Catechol D0816 -0.005758637 -0.012049341 -4.942859e-04 0.082 0.918 Degradation Xenobiotic degradation Phenylacetate positive &lt;- element_predictions %&gt;% filter(mean &gt;0) %&gt;% arrange(mean) %&gt;% filter(positive_support&gt;=0.9) %&gt;% select(-negative_support) %&gt;% rename(support=positive_support) negative &lt;- element_predictions %&gt;% filter(mean &lt;0) %&gt;% arrange(mean) %&gt;% filter(negative_support&gt;=0.9) %&gt;% select(-positive_support) %&gt;% rename(support=negative_support) bind_rows(positive,negative) %&gt;% left_join(GIFT_db,by=join_by(trait==Code_element)) %&gt;% mutate(trait=factor(trait,levels=c(rev(positive$trait),rev(negative$trait)))) %&gt;% ggplot(aes(x=mean, y=fct_rev(trait), xmin=p1, xmax=p9, color=Function)) + geom_point() + geom_errorbar() + xlim(c(-0.04,0.04)) + geom_vline(xintercept=0) + scale_color_manual(values = c(&quot;#debc14&quot;,&quot;#440526&quot;,&quot;#dc7c17&quot;,&quot;#172742&quot;,&quot;#debc14&quot;,&quot;#440526&quot;,&quot;#dc7c17&quot;,&quot;#172742&quot;,&quot;#357379&quot;,&quot;#6c7e2c&quot;,&quot;#d8dc69&quot;,&quot;#774d35&quot;,&quot;#db717d&quot;)) + theme_minimal() + labs(x=&quot;Regression coefficient&quot;,y=&quot;Functional trait&quot;) table &lt;- bind_rows(positive,negative) %&gt;% left_join(unique_funct_db,by=join_by(trait==Code_element)) %&gt;% mutate(trait=factor(trait,levels=c(rev(positive$trait),rev(negative$trait)))) table %&gt;% mutate(Element=factor(Element,levels=c(table$Element))) %&gt;% ggplot(aes(x=mean, y=fct_rev(Element), xmin=p1, xmax=p9, color=Function)) + geom_point() + geom_errorbar() + xlim(c(-0.04,0.04)) + geom_vline(xintercept=0) + scale_color_manual(values = c(&quot;#debc14&quot;,&quot;#440526&quot;,&quot;#dc7c17&quot;,&quot;#172742&quot;,&quot;#debc14&quot;,&quot;#440526&quot;,&quot;#dc7c17&quot;,&quot;#172742&quot;,&quot;#357379&quot;,&quot;#6c7e2c&quot;,&quot;#d8dc69&quot;,&quot;#774d35&quot;,&quot;#db717d&quot;)) + theme_minimal() + labs(x=&quot;Regression coefficient&quot;,y=&quot;Functional trait&quot;) 8.5.2.1 Function level functions_table &lt;- elements_table %&gt;% to.functions(., GIFT_db) %&gt;% as.data.frame() community_functions &lt;- pred %&gt;% group_by(origin, genome) %&gt;% mutate(row_id = row_number()) %&gt;% pivot_wider(names_from = genome, values_from = value) %&gt;% ungroup() %&gt;% group_split(row_id) %&gt;% as.list() %&gt;% lapply(., FUN = function(x){x %&gt;% select(-row_id) %&gt;% column_to_rownames(var = &quot;origin&quot;) %&gt;% as.data.frame() %&gt;% exp() %&gt;% t() %&gt;% tss() %&gt;% to.community(functions_table,.,GIFT_db) %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;origin&quot;) }) #max-min option calculate_slope &lt;- function(x) { lm_fit &lt;- lm(unlist(x) ~ seq_along(unlist(x))) coef(lm_fit)[2] } function_predictions &lt;- map_dfc(community_functions, function(mat) { mat %&gt;% column_to_rownames(var = &quot;origin&quot;) %&gt;% t() %&gt;% as.data.frame() %&gt;% rowwise() %&gt;% mutate(slope = calculate_slope(c_across(everything()))) %&gt;% select(slope) }) %&gt;% t() %&gt;% as.data.frame() %&gt;% set_names(colnames(community_functions[[1]])[-1]) %&gt;% rownames_to_column(var=&quot;iteration&quot;) %&gt;% pivot_longer(!iteration, names_to=&quot;trait&quot;,values_to=&quot;value&quot;) %&gt;% group_by(trait) %&gt;% summarise(mean=mean(value), p1 = quantile(value, probs = 0.1), p9 = quantile(value, probs = 0.9), positive_support = sum(value &gt; 0)/1000, negative_support = sum(value &lt; 0)/1000) %&gt;% arrange(-positive_support) # Positively associated function_predictions %&gt;% filter(mean &gt;0) %&gt;% arrange(-positive_support) %&gt;% tt() tinytable_r58woj39ueby73rscazm .table td.tinytable_css_5cu4ubf462wibb7x3fiu, .table th.tinytable_css_5cu4ubf462wibb7x3fiu { border-bottom: solid 0.1em #d3d8dc; } trait mean p1 p9 positive_support negative_support D02 8.576983e-03 -0.0030125041 0.0209152325 0.830 0.170 B08 7.961926e-03 -0.0032477648 0.0188743831 0.802 0.198 B01 9.281630e-04 -0.0059766852 0.0079648916 0.618 0.382 S01 2.731798e-04 -0.0132584963 0.0135964558 0.557 0.443 B09 6.312351e-05 -0.0005488226 0.0004870937 0.351 0.649 # Negatively associated function_predictions %&gt;% filter(mean &lt;0) %&gt;% arrange(-negative_support) %&gt;% tt() tinytable_9y8bq5f3mbovhd6godhx .table td.tinytable_css_ppoziva1vsia4oqb2nug, .table th.tinytable_css_ppoziva1vsia4oqb2nug { border-bottom: solid 0.1em #d3d8dc; } trait mean p1 p9 positive_support negative_support D08 -1.165491e-03 -0.0023056046 -2.133000e-04 0.039 0.961 B03 -1.075709e-02 -0.0180538256 -3.352306e-03 0.055 0.945 D06 -3.222912e-03 -0.0070543370 6.064845e-05 0.107 0.893 B04 -8.636723e-03 -0.0183948496 3.093139e-04 0.110 0.890 D07 -1.257326e-02 -0.0309368610 3.739348e-03 0.176 0.824 B06 -6.683289e-03 -0.0172253505 3.398578e-03 0.187 0.813 D03 -4.254490e-03 -0.0126850320 3.481236e-03 0.194 0.806 D05 -1.590938e-03 -0.0078006872 3.079704e-03 0.212 0.788 S03 -8.744899e-03 -0.0322687989 1.568934e-02 0.259 0.741 B02 -3.453542e-03 -0.0125046828 4.882872e-03 0.279 0.721 D09 -1.817957e-03 -0.0083503372 4.920801e-03 0.308 0.692 S02 -4.981294e-03 -0.0148126385 3.096444e-03 0.325 0.675 B07 -3.620215e-03 -0.0158983345 9.561511e-03 0.337 0.663 D01 -9.025069e-05 -0.0051113906 4.306304e-03 0.419 0.581 B10 -1.139552e-05 -0.0003108268 2.406163e-04 0.492 0.508 positive &lt;- function_predictions %&gt;% filter(mean &gt;0) %&gt;% arrange(mean) %&gt;% filter(positive_support&gt;=0.9) %&gt;% select(-negative_support) %&gt;% rename(support=positive_support) negative &lt;- function_predictions %&gt;% filter(mean &lt;0) %&gt;% arrange(mean) %&gt;% filter(negative_support&gt;=0.9) %&gt;% select(-positive_support) %&gt;% rename(support=negative_support) bind_rows(positive,negative) %&gt;% left_join(GIFT_db,by=join_by(trait==Code_function)) %&gt;% mutate(trait=factor(trait,levels=c(rev(positive$trait),rev(negative$trait)))) %&gt;% ggplot(aes(x=mean, y=fct_rev(trait), xmin=p1, xmax=p9, color=Function)) + geom_point() + geom_errorbar() + xlim(c(-0.02,0.02)) + geom_vline(xintercept=0) + scale_color_manual(values = c(&quot;#debc14&quot;,&quot;#440526&quot;,&quot;#dc7c17&quot;,&quot;#172742&quot;,&quot;#debc14&quot;,&quot;#440526&quot;,&quot;#dc7c17&quot;,&quot;#172742&quot;,&quot;#357379&quot;,&quot;#6c7e2c&quot;,&quot;#d8dc69&quot;,&quot;#774d35&quot;,&quot;#db717d&quot;)) + theme_minimal() + labs(x=&quot;Regression coefficient&quot;,y=&quot;Functional trait&quot;) "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
